<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dopamine-Driven Resilience Rewiring App - Transform challenges into unstoppable power through neuroscience-based gamification">
    <meta name="theme-color" content="#00ffff">
    <title>NEURO-REWIRE PRO | Dopamine Mastery System</title>
    
    <style>
        /* ===============================================
           CORE VARIABLES & RESET
           =============================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Primary Color Palette */
            --extreme: #ff0040;
            --extreme-dark: #cc0033;
            --extreme-light: #ff3366;
            --high: #ff6b00;
            --high-dark: #cc5500;
            --high-light: #ff8833;
            --moderate: #ffb700;
            --moderate-dark: #cc9200;
            --moderate-light: #ffc933;
            --low: #00ff88;
            --low-dark: #00cc6a;
            --low-light: #33ffaa;
            
            /* UI Colors */
            --bg-dark: #0a0a0a;
            --bg-darker: #050505;
            --bg-card: #1a1a1a;
            --bg-card-hover: #242424;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-tertiary: #666666;
            --accent: #00ffff;
            --accent-dark: #00cccc;
            --accent-light: #33ffff;
            --success: #00ff00;
            --success-dark: #00cc00;
            --warning: #ffff00;
            --warning-dark: #cccc00;
            --danger: #ff0040;
            --danger-dark: #cc0033;
            
            /* Light Theme */
            --light-bg: #f5f5f5;
            --light-bg-card: #ffffff;
            --light-text: #1a1a1a;
            --light-text-secondary: #666666;
            --light-border: #e0e0e0;
            
            /* Shadows & Effects */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(0, 255, 255, 0.5);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 300ms ease;
            --transition-slow: 500ms ease;
            
            /* Z-index Layers */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-overlay: 300;
            --z-modal: 400;
            --z-notification: 500;
            --z-tooltip: 600;
        }

        /* ===============================================
           BASE STYLES
           =============================================== */
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all var(--transition-base);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 64, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 60%, rgba(0, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 90%, rgba(255, 107, 0, 0.08) 0%, transparent 50%);
            animation: backgroundPulse 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.2;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        h1 { font-size: 3rem; }
        h2 { font-size: 2.5rem; }
        h3 { font-size: 2rem; }
        h4 { font-size: 1.5rem; }
        h5 { font-size: 1.25rem; }
        h6 { font-size: 1rem; }

        p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        a {
            color: var(--accent);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--accent-light);
        }

        /* ===============================================
           LIGHT MODE
           =============================================== */
        body.light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }

        body.light-mode::before {
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 64, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 60%, rgba(0, 255, 255, 0.05) 0%, transparent 50%);
        }

        /* ===============================================
           HEADER & NAVIGATION
           =============================================== */
        .header {
            background: linear-gradient(135deg, rgba(255, 0, 64, 0.1), rgba(0, 255, 255, 0.1));
            border-bottom: 2px solid var(--accent);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--extreme), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            animation: logoRotate 20s linear infinite;
        }

        @keyframes logoRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--extreme), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        .theme-toggle:hover {
            background: var(--accent);
            color: var(--bg-dark);
            transform: scale(1.1);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--extreme));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }

        /* ===============================================
           NAVIGATION TABS
           =============================================== */
        .nav-container {
            background: var(--bg-darker);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 82px;
            z-index: var(--z-sticky);
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-dark);
        }

        .nav-container::-webkit-scrollbar {
            height: 4px;
        }

        .nav-container::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .nav-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            min-width: max-content;
            padding: 0 2rem;
        }

        .nav-tab {
            position: relative;
            padding: 1.25rem 2rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 80%;
            height: 3px;
            background: var(--accent);
            transition: transform var(--transition-base);
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(0, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--accent);
        }

        .nav-tab.active::after {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-tab-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: bold;
        }

        /* ===============================================
           TAB CONTENT CONTAINERS
           =============================================== */
        .tab-content {
            display: none;
            animation: fadeIn var(--transition-slow);
            min-height: calc(100vh - 160px);
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===============================================
           DASHBOARD STATS GRID
           =============================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            animation: statCardRotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes statCardRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), var(--extreme));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
        }

        .stat-change {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 255, 0, 0.1);
            color: var(--success);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-change.negative {
            background: rgba(255, 0, 64, 0.1);
            color: var(--danger);
        }

        /* ===============================================
           CHALLENGE CARDS
           =============================================== */
        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .challenge-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .challenge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left var(--transition-slow);
        }

        .challenge-card:hover::before {
            left: 100%;
        }

        .challenge-card.extreme {
            border-color: var(--extreme);
            background: linear-gradient(135deg, rgba(255, 0, 64, 0.05), transparent);
        }

        .challenge-card.high {
            border-color: var(--high);
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.05), transparent);
        }

        .challenge-card.moderate {
            border-color: var(--moderate);
            background: linear-gradient(135deg, rgba(255, 183, 0, 0.05), transparent);
        }

        .challenge-card.low {
            border-color: var(--low);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .challenge-card.selected {
            transform: scale(1.05);
            box-shadow: 0 0 30px currentColor;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .challenge-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .challenge-difficulty {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .challenge-difficulty.extreme {
            background: var(--extreme);
            color: white;
        }

        .challenge-difficulty.high {
            background: var(--high);
            color: white;
        }

        .challenge-difficulty.moderate {
            background: var(--moderate);
            color: var(--bg-dark);
        }

        .challenge-difficulty.low {
            background: var(--low);
            color: var(--bg-dark);
        }

        .challenge-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .challenge-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .challenge-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-tertiary);
        }

        .challenge-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* ===============================================
           BUTTONS
           =============================================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width var(--transition-slow), height var(--transition-slow);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--extreme), var(--accent));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--accent);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-dark), var(--success));
            color: var(--bg-dark);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-dark), var(--warning));
            color: var(--bg-dark);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-dark), var(--danger));
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-ghost:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
        }

        /* ===============================================
           FORMS & INPUTS
           =============================================== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-checkbox,
        .form-radio {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .form-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .form-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .form-switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-base);
            border-radius: 30px;
        }

        .form-switch-slider::before {
            position: absolute;
            content: '';
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: var(--text-secondary);
            transition: var(--transition-base);
            border-radius: 50%;
        }

        .form-switch input:checked + .form-switch-slider {
            background: var(--accent);
            border-color: var(--accent);
        }

        .form-switch input:checked + .form-switch-slider::before {
            transform: translateX(30px);
            background: white;
        }

        /* Range Slider */
        .range-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--low), var(--moderate), var(--high), var(--extreme));
            outline: none;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--accent);
            box-shadow: var(--shadow-lg);
        }

        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--accent);
            box-shadow: var(--shadow-lg);
        }

        .range-value {
            display: inline-block;
            background: var(--accent);
            color: var(--bg-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 1rem;
        }

        /* ===============================================
           CARDS & PANELS
           =============================================== */
        .card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all var(--transition-base);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .card-body {
            padding: 0;
        }

        .card-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ===============================================
           SESSION PANEL
           =============================================== */
        .session-panel {
            background: linear-gradient(135deg, var(--bg-card), rgba(255, 0, 64, 0.05));
            border: 2px solid var(--extreme);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .session-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 0, 64, 0.1) 0%, transparent 70%);
            animation: sessionPulse 3s ease-in-out infinite;
        }

        @keyframes sessionPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .session-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .session-title {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--extreme), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .identity-phrase {
            font-size: 1.5rem;
            font-style: italic;
            color: var(--warning);
            opacity: 0.9;
            animation: identityPulse 2s infinite;
        }

        @keyframes identityPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* Timer Display */
        .timer-display {
            font-size: 5rem;
            font-weight: 900;
            text-align: center;
            margin: 2rem 0;
            background: linear-gradient(45deg, var(--extreme), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            position: relative;
            z-index: 1;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* ===============================================
           PROGRESS BARS
           =============================================== */
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-darker);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--low), var(--moderate), var(--high), var(--extreme));
            border-radius: 15px;
            transition: width var(--transition-slow);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s linear infinite;
        }

        @keyframes progressShine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .progress-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* ===============================================
           MODALS
           =============================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: var(--z-overlay);
            animation: fadeIn var(--transition-base);
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn var(--transition-slow);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            background: var(--danger);
            transform: rotate(90deg);
        }

        /* Reward Modal Special */
        .reward-modal {
            text-align: center;
            padding: 3rem;
            background: linear-gradient(135deg, var(--bg-card), rgba(0, 255, 0, 0.1));
            border-color: var(--success);
        }

        .reward-modal-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: rewardBounce 1s infinite;
        }

        @keyframes rewardBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(-5deg); }
            75% { transform: translateY(-20px) rotate(5deg); }
        }

        .reward-points {
            font-size: 3rem;
            font-weight: 900;
            color: var(--success);
            margin: 1rem 0;
            text-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        /* ===============================================
           NOTIFICATIONS
           =============================================== */
        .notification-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: var(--z-notification);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .notification {
            background: var(--bg-card);
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            min-width: 300px;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
            animation: notificationSlideIn var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.danger {
            border-left-color: var(--danger);
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            animation: notificationProgress 5s linear;
        }

        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ===============================================
           CHARTS & VISUALIZATIONS
           =============================================== */
        .chart-container {
            background: var(--bg-darker);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
            min-height: 300px;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 40px;
            background: linear-gradient(to top, var(--extreme), var(--accent));
            border-radius: 4px 4px 0 0;
            transition: height var(--transition-slow);
            cursor: pointer;
        }

        .chart-bar:hover {
            filter: brightness(1.2);
            transform: scaleY(1.05);
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 1rem 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .heatmap-cell.level-0 { background: rgba(0, 255, 255, 0.05); }
        .heatmap-cell.level-1 { background: rgba(0, 255, 255, 0.2); }
        .heatmap-cell.level-2 { background: rgba(0, 255, 255, 0.4); }
        .heatmap-cell.level-3 { background: rgba(0, 255, 255, 0.6); }
        .heatmap-cell.level-4 { background: rgba(0, 255, 255, 0.8); }
        .heatmap-cell.level-5 { 
            background: var(--accent); 
            color: var(--bg-dark);
            box-shadow: 0 0 10px var(--accent);
        }

        /* ===============================================
           SHOP & REWARDS
           =============================================== */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .shop-item {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .shop-item::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255, 215, 0, 0.1));
            transition: top var(--transition-slow);
        }

        .shop-item:hover::before {
            top: 0;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: gold;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .shop-item-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .shop-item-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .shop-item-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            min-height: 60px;
        }

        .shop-item-cost {
            font-size: 1.5rem;
            font-weight: 900;
            color: gold;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .shop-item.purchased {
            opacity: 0.6;
            pointer-events: none;
        }

        .shop-item.purchased::after {
            content: 'OWNED';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 2rem;
            font-weight: 900;
            color: var(--success);
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* ===============================================
           DAILY ROUTINE (NEW)
           =============================================== */
        .routine-timeline {
            position: relative;
            padding-left: 40px;
            margin: 2rem 0;
        }

        .routine-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent), transparent);
        }

        .routine-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .routine-item::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg-dark);
            z-index: 1;
        }

        .routine-item:hover {
            transform: translateX(5px);
            border-color: var(--accent);
        }

        .routine-item.completed {
            border-color: var(--success);
            background: rgba(0, 255, 0, 0.05);
        }

        .routine-item.completed::before {
            background: var(--success);
        }

        .routine-item.missed {
            border-color: var(--danger);
            background: rgba(255, 0, 64, 0.05);
        }

        .routine-item.missed::before {
            background: var(--danger);
        }

        .routine-time {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            min-width: 60px;
            text-align: center;
        }

        .routine-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .routine-info {
            flex: 1;
        }

        .routine-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .routine-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* New Styles for Enhanced Tracker */
        .progress-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .progress-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .intensity-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .intensity-level {
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid;
        }

        .intensity-level.extreme { border-color: var(--extreme); }
        .intensity-level.high { border-color: var(--high); }
        .intensity-level.moderate { border-color: var(--moderate); }

        .transformation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: var(--bg-darker);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent);
            margin: 0.5rem 0;
        }

        .metric-target {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .safety-rules {
            background: rgba(255, 0, 64, 0.1);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .safety-rules h4 {
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .safety-rules ul {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .heatmap-legend .heatmap-cell {
            width: 20px;
            height: 20px;
        }

        /* ===============================================
           BADGES & ACHIEVEMENTS
           =============================================== */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .badge {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
        }

        .badge.earned {
            border-color: gold;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), transparent);
        }

        .badge:hover {
            transform: translateY(-5px) rotate(5deg);
            box-shadow: var(--shadow-lg);
        }

        .badge-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            filter: grayscale(1);
            opacity: 0.3;
            transition: all var(--transition-base);
        }

        .badge.earned .badge-icon {
            filter: grayscale(0);
            opacity: 1;
            animation: badgeShine 2s ease infinite;
        }

        @keyframes badgeShine {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        .badge-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .badge.earned .badge-name {
            color: gold;
        }

        /* ===============================================
           LEADERBOARD
           =============================================== */
        .leaderboard {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
        }

        .leaderboard-header {
            background: linear-gradient(135deg, var(--extreme), var(--accent));
            padding: 1.5rem;
            text-align: center;
        }

        .leaderboard-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .leaderboard-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all var(--transition-base);
        }

        .leaderboard-item:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.25rem;
        }

        .leaderboard-item:nth-child(1) .leaderboard-rank {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: var(--bg-dark);
        }

        .leaderboard-item:nth-child(2) .leaderboard-rank {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: var(--bg-dark);
        }

        .leaderboard-item:nth-child(3) .leaderboard-rank {
            background: linear-gradient(135deg, #cd7f32, #d4a76a);
            color: white;
        }

        .leaderboard-user {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .leaderboard-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .leaderboard-score {
            font-size: 1.25rem;
            font-weight: 900;
            color: var(--accent);
        }

        /* ===============================================
           SETTINGS
           =============================================== */
        .settings-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .setting-label-primary {
            font-weight: 600;
            color: var(--text-primary);
        }

        .setting-label-secondary {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ===============================================
           RESPONSIVE DESIGN
           =============================================== */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-tabs {
                padding: 0 1rem;
            }

            .nav-tab {
                padding: 1rem;
                font-size: 0.875rem;
            }

            .challenges-grid {
                grid-template-columns: 1fr;
            }

            .shop-grid {
                grid-template-columns: 1fr;
            }

            .timer-display {
                font-size: 3rem;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }

            h1 { font-size: 2rem; }
            h2 { font-size: 1.75rem; }
            h3 { font-size: 1.5rem; }
        }

        @media (max-width: 480px) {
            .nav-tab {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
        }

        /* ===============================================
           UTILITY CLASSES
           =============================================== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .gap-4 { gap: 2rem; }

        /* ===============================================
           ANIMATIONS
           =============================================== */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent); }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-slide-left { animation: slideInLeft 0.5s ease-out; }
        .animate-slide-right { animation: slideInRight 0.5s ease-out; }
        .animate-scale { animation: scaleIn 0.5s ease-out; }

        /* ===============================================
           LOADING STATES
           =============================================== */
        .skeleton {
            background: linear-gradient(90deg, 
                var(--bg-card) 25%, 
                rgba(255, 255, 255, 0.1) 50%, 
                var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: skeletonLoading 2s infinite;
        }

        @keyframes skeletonLoading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===============================================
           TOOLTIPS
           =============================================== */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            border: 1px solid var(--accent);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-base);
            z-index: var(--z-tooltip);
        }

        .tooltip:hover .tooltip-content {
            opacity: 1;
        }

        /* ===============================================
           SCROLLBARS
           =============================================== */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-light);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-darker);
        }
    </style>
</head>
<body>
    <!--
    CHANGELOG:
    - Implemented `routineTracker` class with `getTodayTemplate`, `generateScheduleFor`, `seedTodaysRoutine`, `renderDailySchedule`, `startSession`, `markCompleted`, `getWeekSummary`, `updateProgressUI` methods.
    - Integrated Chart.js via CDN for `weeklyProgressChart`, `sudsProgressChart`, and `challengeDistributionChart`.
    - Enhanced `renderMonthlyHeatmap` to show daily intensity levels.
    - Added weekly enforcement logic for micro/medium/heavy sessions based on intensity template.
    - Implemented heavy session blocking based on SUDS trend and safety flags.
    - Refactored session persistence to use ISO date keys for daily schedules.
    - Implemented a bounded variable-ratio bonus for DP awards with a daily cap.
    - Integrated pre/post-session SUDS tracking in the session modal.
    - Implemented Safety Monitor with `emergencyProtocol()` to block heavy sessions and show crisis resources.
    - Added a permanent "ACTIVATE EMERGENCY STOP" button.
    - Ensured keyboard accessibility and ARIA labels for modals and important buttons.
    - Added confirmation prompts for destructive actions.
    - Added a "Run Smoke Tests" button and associated functionality for verification.
    - Included DEV NOTES section for tuning constants.
    - Refactored JavaScript into a single script block at the end.
    - Added `dayjs` CDN for simplified date handling.
    - Renamed `routineBadge` to `routineNewBadge` for clarity.
    - Removed `todaysChallenges` from dashboard as routine tab now handles daily schedule.
    - Added a disclaimer about professional mental health care.

    HOW TO TEST:
    1. Open the HTML file in a modern web browser.
    2. **Initial Setup**: The app will load. Click "OK" on the initial safety warning.
    3. **Routine Tab**: Navigate to the "My Routine" tab.
       - Click "Generate Today's Routine". You should see a list of routine items for the current day.
       - Click "Previous Day" and "Next Day" to navigate. The schedule should update.
    4. **Complete a Routine Item**:
       - Click "Complete" on a "micro" routine item. The "Routine Detail Modal" will appear.
       - Adjust the "Current SUDS Level" slider.
       - Add some notes.
       - Click "Complete". You should see a success notification with DP earned, and the item will be marked as completed. Your DP in the header should update.
    5. **Start a Challenge (from Challenges tab)**:
       - Go to the "Challenges" tab.
       - Click "Start Challenge" on any challenge. The "Active Session Modal" will appear.
       - Adjust "SUDS Level" and "Current Mood".
       - Click "START CHALLENGE". The timer will begin.
       - After a few seconds, click "COMPLETE". You should see the "Reward Modal" with DP earned, and your header DP will update.
    6. **Check Analytics**: Go to the "Analytics" tab.
       - The "Performance Metrics" should reflect your completed sessions.
       - The "SUDS Reduction Journey" and "Challenge Distribution" charts should show data (may be minimal initially).
       - The "Dopamine Points Heatmap" should show activity for today.
    7. **Safety Monitor & Emergency Stop**:
       - Go to the "My Routine" tab.
       - Click the "ACTIVATE EMERGENCY STOP" button. Confirm the prompts. A modal with crisis resources should appear, and any active session will be cleared.
    8. **Smoke Tests**:
       - Go to the "Settings" tab.
       - Scroll down to "Run Smoke Tests" and click the button.
       - A modal will appear showing the results of simulated routine generation and session completions, verifying core logic.
    9. **Data Persistence**:
       - Close and reopen the browser tab. Your DP, completed sessions, and routine data should be preserved.
    10. **Theme Toggle**: Click the moon/sun icon in the header to switch themes.
    -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/plugin/isoWeek.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/plugin/weekOfYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/plugin/isBetween.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_weekday);
        dayjs.extend(dayjs_plugin_isoWeek);
        dayjs.extend(dayjs_plugin_weekOfYear);
        dayjs.extend(dayjs_plugin_isBetween);
    </script>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="modal-overlay active" style="background: var(--bg-dark); z-index: 10000;">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">Neuro-Rewire</div>
            </div>
            
            <div class="header-actions">
                <div class="tooltip">
                    <div class="stat-value" style="font-size: 1.5rem;">
                        <span id="headerDopaminePoints">0</span> DP
                    </div>
                    <div class="tooltip-content">Dopamine Points</div>
                </div>
                
                <div class="tooltip">
                    <div class="stat-value" style="font-size: 1.5rem;">
                        Lvl <span id="headerLevel">1</span>
                    </div>
                    <div class="tooltip-content">Your Level</div>
                </div>
                
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle Theme">
                    <span id="themeIcon"></span>
                </button>
                
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">
                        <span id="userInitial">U</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">
                Dashboard
                <span class="nav-tab-badge hidden" id="dashboardBadge">!</span>
            </button>
            <button class="nav-tab" data-tab="challenges">
                Challenges
                <span class="nav-tab-badge hidden" id="challengesBadge">34</span>
            </button>
            <button class="nav-tab" data-tab="routine">
                My Routine
                <span class="nav-tab-badge" id="routineNewBadge">NEW</span>
            </button>
            <button class="nav-tab" data-tab="shop">
                Shop
                <span class="nav-tab-badge hidden" id="shopBadge">NEW</span>
            </button>
            <button class="nav-tab" data-tab="analytics">
                Analytics
            </button>
            <button class="nav-tab" data-tab="social">
                Social
            </button>
            <button class="nav-tab" data-tab="achievements">
                Achievements
            </button>
            <button class="nav-tab" data-tab="settings">
                Settings
            </button>
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="container">
            <!-- Welcome Section -->
            <div class="card animate-slide-left">
                <div class="card-body">
                    <h2 id="welcomeMessage">Welcome back, Warrior!</h2>
                    <p class="text-secondary">Ready to transform challenges into power? Your neural pathways await rewiring.</p>
                    <p class="text-secondary" style="color: var(--danger); font-weight: bold;">Disclaimer: This tool is NOT a substitute for professional mental health care. If you are experiencing a mental health crisis, please seek immediate professional help.</p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card animate-scale">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Total Challenges</div>
                    <div class="stat-value" id="totalChallenges">0</div>
                    <div class="stat-change">+5 this week</div>
                </div>
                
                <div class="stat-card animate-scale" style="animation-delay: 0.1s;">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Current Streak</div>
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-change">Keep going!</div>
                </div>
                
                <div class="stat-card animate-scale" style="animation-delay: 0.2s;">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Dopamine Points</div>
                    <div class="stat-value" id="dopaminePoints">0</div>
                    <div class="stat-change">+250 today</div>
                </div>
                
                <div class="stat-card animate-scale" style="animation-delay: 0.3s;">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Avg SUDS Drop</div>
                    <div class="stat-value" id="avgSudsDrop">0%</div>
                    <div class="stat-change">Improving!</div>
                </div>
                
                <div class="stat-card animate-scale" style="animation-delay: 0.4s;">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Total Time</div>
                    <div class="stat-value" id="totalTime">0h</div>
                    <div class="stat-change">+2h today</div>
                </div>
                
                <div class="stat-card animate-scale" style="animation-delay: 0.5s;">
                    <div class="stat-icon"></div>
                    <div class="stat-label">Achievements</div>
                    <div class="stat-value" id="totalAchievements">0</div>
                    <div class="stat-change">2 close to unlock</div>
                </div>
            </div>

            <!-- Today's Focus -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Today's Focus</h3>
                    <button class="btn btn-sm btn-ghost" onclick="app.switchTab('routine')">View Routine</button>
                </div>
                <div class="card-body">
                    <div class="challenges-grid" id="todaysFocusChallenges">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Progress Overview -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Weekly Progress</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weeklyProgressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="app.startRandomChallenge()">
                            Random Challenge
                        </button>
                        <button class="btn btn-secondary" onclick="openCustomChallengeModal()">
                            Create Custom
                        </button>
                        <button class="btn btn-ghost" onclick="app.exportData()">
                            Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenges Tab -->
    <div id="challenges" class="tab-content">
        <div class="container">
            <!-- Challenge Filters -->
            <div class="card">
                <div class="card-body">
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-primary" onclick="filterChallenges('all', this)">All</button>
                        <button class="btn btn-sm btn-ghost" onclick="filterChallenges('extreme', this)">Extreme</button>
                        <button class="btn btn-sm btn-ghost" onclick="filterChallenges('high', this)">High</button>
                        <button class="btn btn-sm btn-ghost" onclick="filterChallenges('moderate', this)">Moderate</button>
                        <button class="btn btn-sm btn-ghost" onclick="filterChallenges('low', this)">Low</button>
                    </div>
                </div>
            </div>

            <!-- Challenges Grid -->
            <div class="challenges-grid" id="challengesGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Routine Tab (ENHANCED) -->
    <div id="routine" class="tab-content">
        <div class="container">
            <!-- Daily Schedule Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Pain-to-Power Schedule</h3>
                    <div class="flex gap-2 items-center">
                        <button class="btn btn-sm btn-secondary" id="prevDayRoutine" aria-label="Previous Day" onclick="routineTracker.changeDay(-1)"></button>
                        <span class="text-secondary" id="routineDate">Monday, January 1</span>
                        <button class="btn btn-sm btn-secondary" id="nextDayRoutine" aria-label="Next Day" onclick="routineTracker.changeDay(1)"></button>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="routineTracker.seedTodaysRoutine(); routineTracker.renderDailySchedule();">
                        Generate Today's Routine
                    </button>
                </div>
                <div class="card-body">
                    <div id="dailySchedule" class="routine-timeline">
                        <!-- Daily schedule will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Weekly Progress Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Weekly Targets & Progress</h3>
                    <button class="btn btn-ghost btn-sm" onclick="routineTracker.updateProgressUI()">Refresh</button>
                </div>
                <div class="card-body" id="weeklyProgress">
                    <!-- Weekly progress bars will be populated here -->
                    <div class="progress-grid">
                        <div class="progress-item">
                            <span>Micro Sessions</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="microProgressFill" style="width: 0%;"></div>
                                <div class="progress-label" id="microProgressLabel">0/0</div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span>Medium Sessions</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="mediumProgressFill" style="width: 0%;"></div>
                                <div class="progress-label" id="mediumProgressLabel">0/0</div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span>Heavy Sessions</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="heavyProgressFill" style="width: 0%;"></div>
                                <div class="progress-label" id="heavyProgressLabel">0/0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intensity Scaling -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Adaptive Intensity Engine</h3>
                </div>
                <div class="card-body">
                    <div class="intensity-matrix">
                        <div class="intensity-level extreme">
                            <h4>EXTREME (95-98%)</h4>
                            <p>3x daily micro, 2x weekly heavy</p>
                            <div id="extremeProgress"></div>
                        </div>
                        <div class="intensity-level high">
                            <h4>HIGH (90-94%)</h4>
                            <p>2x daily micro, 1x weekly heavy</p>
                            <div id="highProgress"></div>
                        </div>
                        <div class="intensity-level moderate">
                            <h4>MODERATE (85-89%)</h4>
                            <p>1x daily micro, 2x weekly medium</p>
                            <div id="moderateProgress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Overview with Heatmap -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Monthly Transformation Heatmap</h3>
                </div>
                <div class="card-body">
                    <div class="heatmap-grid" id="monthlyHeatmap">
                        <!-- Heatmap will be populated here -->
                    </div>
                    <div class="heatmap-legend">
                        <span>Less</span>
                        <div class="heatmap-cell level-0"></div>
                        <div class="heatmap-cell level-1"></div>
                        <div class="heatmap-cell level-2"></div>
                        <div class="heatmap-cell level-3"></div>
                        <div class="heatmap-cell level-4"></div>
                        <div class="heatmap-cell level-5"></div>
                        <span>More</span>
                    </div>
                </div>
            </div>

            <!-- Safety Monitor -->
            <div class="card" style="border: 2px solid var(--danger);">
                <div class="card-header">
                    <h3 class="card-title" style="color: var(--danger);">Safety Monitor</h3>
                </div>
                <div class="card-body">
                    <div class="safety-rules">
                        <h4>RED FLAGS - STOP IMMEDIATELY:</h4>
                        <ul>
                            <li>Suicidal ideation or self-harm thoughts</li>
                            <li>Dissociation lasting >15 minutes</li>
                            <li>Panic attacks with physical symptoms</li>
                            <li>PTSD flashback activation</li>
                            <li>Violent impulses toward others</li>
                        </ul>
                        <button class="btn btn-danger" onclick="app.emergencyProtocol()">
                            ACTIVATE EMERGENCY STOP
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Tab -->
    <div id="shop" class="tab-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Dopamine Rewards Shop</h3>
                    <div class="stat-value" style="font-size: 1.5rem;">
                        <span id="shopDopaminePoints">0</span> DP Available
                    </div>
                </div>
            </div>

            <div class="shop-grid" id="shopGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
        <div class="container">
            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Metrics</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value" id="successRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Session Time</div>
                            <div class="stat-value" id="avgSessionTime">0m</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Sessions</div>
                            <div class="stat-value" id="totalSessions">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Best Streak</div>
                            <div class="stat-value" id="bestStreak">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUDS Progress Chart -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">SUDS Reduction Journey</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" id="sudsChartContainer">
                        <canvas id="sudsProgressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Dopamine Heatmap -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Dopamine Points Heatmap</h3>
                </div>
                <div class="card-body">
                    <div class="heatmap-grid" id="dopamineHeatmap">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Challenge Distribution -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Challenge Distribution</h3>
                </div>
                <div class="card-body">
                    <canvas id="challengeDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Social Tab -->
    <div id="social" class="tab-content">
        <div class="container">
            <!-- Leaderboard -->
            <div class="leaderboard">
                <div class="leaderboard-header">
                    <div class="leaderboard-title">Global Leaderboard</div>
                </div>
                <ul class="leaderboard-list" id="leaderboardList">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>

            <!-- Community Challenges -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Community Challenges</h3>
                </div>
                <div class="card-body">
                    <div class="challenges-grid" id="communityChallenges">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Friend Activity -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Friend Activity</h3>
                </div>
                <div class="card-body" id="friendActivity">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Tab -->
    <div id="achievements" class="tab-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Your Achievements</h3>
                    <span class="text-secondary"><span id="earnedBadges">0</span> / <span id="totalBadges">50</span> Unlocked</span>
                </div>
            </div>

            <div class="badges-grid" id="badgesGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="container">
            <!-- Profile Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">Profile Settings</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Display Name</div>
                        <div class="setting-label-secondary">How you appear to others</div>
                    </div>
                    <input type="text" class="form-input" id="displayName" placeholder="Enter your name" style="width: 250px;">
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Avatar</div>
                        <div class="setting-label-secondary">Choose your avatar</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-secondary">Choose Avatar</button>
                        <button class="btn btn-sm btn-ghost">Remove</button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Bio</div>
                        <div class="setting-label-secondary">Tell us about yourself</div>
                    </div>
                    <textarea class="form-textarea" id="userBio" placeholder="Your bio..." style="width: 100%; margin-top: 0.5rem;"></textarea>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">Notifications</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Push Notifications</div>
                        <div class="setting-label-secondary">Get reminders for scheduled challenges</div>
                    </div>
                    <label class="form-switch">
                        <input type="checkbox" id="pushNotifications">
                        <span class="form-switch-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Email Notifications</div>
                        <div class="setting-label-secondary">Weekly progress reports</div>
                    </div>
                    <label class="form-switch">
                        <input type="checkbox" id="emailNotifications">
                        <span class="form-switch-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Sound Effects</div>
                        <div class="setting-label-secondary">Play sounds for achievements</div>
                    </div>
                    <label class="form-switch">
                        <input type="checkbox" id="soundEffects" checked>
                        <span class="form-switch-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Reminder Time</div>
                        <div class="setting-label-secondary">Daily challenge reminder</div>
                    </div>
                    <input type="time" class="form-input" id="reminderTime" value="09:00" style="width: 150px;">
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">Privacy</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Profile Visibility</div>
                        <div class="setting-label-secondary">Who can see your profile</div>
                    </div>
                    <select class="form-select" id="profileVisibility" style="width: 200px;">
                        <option value="public">Public</option>
                        <option value="friends">Friends Only</option>
                        <option value="private">Private</option>
                    </select>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Share Progress</div>
                        <div class="setting-label-secondary">Show your stats on leaderboard</div>
                    </div>
                    <label class="form-switch">
                        <input type="checkbox" id="shareProgress" checked>
                        <span class="form-switch-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Data Management -->
            <div class="settings-section">
                <h3 class="settings-section-title">Data Management</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Export Data</div>
                        <div class="setting-label-secondary">Download all your data</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="app.exportData()">Export JSON</button>
                        <button class="btn btn-sm btn-secondary" onclick="app.exportCSV()">Export CSV</button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Import Data</div>
                        <div class="setting-label-secondary">Restore from backup</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="app.importData()">Import</button>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Clear Data</div>
                        <div class="setting-label-secondary">Reset all progress (cannot be undone)</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="app.clearAllData()">Clear All Data</button>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="settings-section">
                <h3 class="settings-section-title">Emergency Contact</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Contact Name</div>
                        <div class="setting-label-secondary">Who to contact in emergency</div>
                    </div>
                    <input type="text" class="form-input" id="emergencyName" placeholder="Contact name" style="width: 250px;">
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Contact Number</div>
                        <div class="setting-label-secondary">Emergency phone number</div>
                    </div>
                    <input type="tel" class="form-input" id="emergencyPhone" placeholder="+1234567890" style="width: 250px;">
                </div>

                <div class="setting-item">
                    <button class="btn btn-primary" onclick="app.saveEmergencyContact()">Save Emergency Contact</button>
                </div>
            </div>

            <!-- Smoke Tests -->
            <div class="settings-section">
                <h3 class="settings-section-title">Developer Tools</h3>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-label-primary">Run Smoke Tests</div>
                        <div class="setting-label-secondary">Verify core functionality</div>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="app.runSmokeTests()">Run Smoke Tests</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Session Modal -->
    <div class="modal-overlay" id="sessionModal" role="dialog" aria-modal="true" aria-labelledby="sessionTitle">
        <div class="modal session-panel" style="max-width: 800px;">
            <button class="modal-close" onclick="app.closeSessionModal()" aria-label="Close Session"></button>
            
            <div class="session-header">
                <h2 class="session-title" id="sessionTitle">CHALLENGE NAME</h2>
                <div class="identity-phrase" id="identityPhrase">"Transform pain into power"</div>
            </div>

            <div class="timer-display" id="timerDisplay">00:00</div>

            <!-- SUDS Tracker -->
            <div class="card" style="background: rgba(0,0,0,0.3);">
                <div class="card-body">
                    <h4 class="mb-2">SUDS Level (Subjective Units of Distress)</h4>
                    <input type="range" class="range-slider" id="sudsSlider" min="0" max="100" value="50" aria-label="SUDS Level">
                    <div class="text-center">
                        <span class="range-value" id="sudsValue">50</span>
                    </div>
                </div>
            </div>

            <!-- Mood Tracker -->
            <div class="card mt-2" style="background: rgba(0,0,0,0.3);">
                <div class="card-body">
                    <h4 class="mb-2">Current Mood</h4>
                    <input type="range" class="range-slider" id="moodSlider" min="0" max="100" value="50" aria-label="Current Mood">
                    <div class="text-center">
                        <span class="range-value" id="moodValue">Neutral</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="card mt-2" style="background: rgba(0,0,0,0.3);">
                <div class="card-body">
                    <h4 class="mb-2">Reflection Notes</h4>
                    <textarea class="form-textarea" id="sessionNotes" placeholder="What insights emerged? How did you transform this challenge?" aria-label="Session Notes"></textarea>
                    <div class="text-right text-secondary mt-1">
                        <span id="noteCharCount">0</span> / 1000
                    </div>
                </div>
            </div>

            <!-- Safety Check -->
            <div class="card mt-2" style="background: rgba(255, 0, 64, 0.1); border-color: var(--danger);">
                <div class="card-body">
                    <h4 class="mb-2" style="color: var(--danger);">Safety Check (Select if applicable)</h4>
                    <div class="form-group">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" class="form-checkbox" id="safetyFlagSuicidal">
                            Suicidal ideation or self-harm thoughts
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" class="form-checkbox" id="safetyFlagDissociation">
                            Dissociation lasting >15 minutes
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" class="form-checkbox" id="safetyFlagPanic">
                            Panic attack with physical symptoms
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" class="form-checkbox" id="safetyFlagPTSD">
                            PTSD flashback activation
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" class="form-checkbox" id="safetyFlagViolent">
                            Violent impulses toward others
                        </label>
                    </div>
                </div>
            </div>

            <!-- Session Controls -->
            <div class="timer-controls">
                <button class="btn btn-primary btn-lg" id="startBtn" onclick="app.startSession()" aria-label="Start Challenge">
                    START CHALLENGE
                </button>
                <button class="btn btn-success btn-lg hidden" id="completeBtn" onclick="app.completeSession()" aria-label="Complete Challenge">
                    COMPLETE
                </button>
                <button class="btn btn-warning btn-lg hidden" id="pauseBtn" onclick="app.pauseSession()" aria-label="Pause Session">
                    PAUSE
                </button>
                <button class="btn btn-danger" onclick="app.emergencyProtocol()" aria-label="Emergency Stop">
                    EMERGENCY STOP
                </button>
            </div>

            <!-- Protocol Steps -->
            <div class="card mt-3" style="background: rgba(255,0,64,0.1);">
                <div class="card-body">
                    <h4>Protocol Instructions</h4>
                    <p id="protocolSteps">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Routine Detail Modal -->
    <div class="modal-overlay" id="routineDetailModal" role="dialog" aria-modal="true" aria-labelledby="routineDetailTitle">
        <div class="modal" style="max-width: 800px;">
            <button class="modal-close" onclick="app.closeRoutineDetailModal()" aria-label="Close Routine Details"></button>
            <h2 class="mb-3" id="routineDetailTitle"></h2>
            <p class="text-secondary mb-3" id="routineDetailTime"></p>

            <div class="card mb-3">
                <div class="card-body">
                    <h4 class="mb-2">Description</h4>
                    <p id="routineDetailDescription"></p>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h4 class="mb-2">Scientific Explanation</h4>
                    <p id="routineDetailScience"></p>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h4 class="mb-2">Step-by-Step Instructions</h4>
                    <p id="routineDetailInstructions"></p>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h4 class="mb-2">Exact Action</h4>
                    <p id="routineDetailAction"></p>
                </div>
            </div>

            <!-- SUDS Tracker for Routine -->
            <div class="card" style="background: rgba(0,0,0,0.3);">
                <div class="card-body">
                    <h4 class="mb-2">Current SUDS Level (Subjective Units of Distress)</h4>
                    <input type="range" class="range-slider" id="routineSudsSlider" min="0" max="100" value="50" aria-label="Routine SUDS Level">
                    <div class="text-center">
                        <span class="range-value" id="routineSudsValue">50</span>
                    </div>
                </div>
            </div>

            <div class="form-group mt-3">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="routineDetailNotes" placeholder="What insights emerged?" aria-label="Routine Notes"></textarea>
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <button class="btn btn-success" id="completeRoutineBtn" aria-label="Complete Routine">Complete</button>
                <button class="btn btn-ghost" onclick="app.closeRoutineDetailModal()" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reward Modal -->
    <div class="modal-overlay" id="rewardModal" role="dialog" aria-modal="true" aria-labelledby="rewardTitle">
        <div class="modal reward-modal">
            <h2 id="rewardTitle" style="color: var(--success);">CHALLENGE COMPLETED!</h2>
            <div class="reward-modal-icon"></div>
            <div class="reward-points">+<span id="rewardPoints">0</span> DP</div>
            <p id="rewardMessage" style="margin: 1rem 0;">Amazing work!</p>
            
            <div class="stats-grid" style="margin: 2rem 0;">
                <div class="stat-card">
                    <div class="stat-label">SUDS Drop</div>
                    <div class="stat-value" id="rewardSudsDrop">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Session Time</div>
                    <div class="stat-value" id="rewardTime">0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Bonus Points</div>
                    <div class="stat-value" id="rewardBonus">0</div>
                </div>
            </div>

            <button class="btn btn-primary btn-lg" onclick="app.closeRewardModal()" aria-label="Continue Transformation">
                CONTINUE TRANSFORMATION
            </button>
        </div>
    </div>

    <!-- Custom Challenge Modal -->
    <div class="modal-overlay" id="customChallengeModal" role="dialog" aria-modal="true" aria-labelledby="customChallengeTitle">
        <div class="modal" style="max-width: 700px;">
            <button class="modal-close" onclick="app.closeCustomChallengeModal()" aria-label="Close Custom Challenge"></button>
            <h2 class="mb-3" id="customChallengeTitle">Create Custom Challenge</h2>
            
            <div class="form-group">
                <label class="form-label">Challenge Title</label>
                <input type="text" class="form-input" id="customTitle" placeholder="e.g., Public Speaking Practice" aria-label="Challenge Title">
            </div>

            <div class="form-group">
                <label class="form-label">Difficulty (0-100)</label>
                <input type="range" class="range-slider" id="customDifficulty" min="0" max="100" value="50" aria-label="Difficulty">
                <span class="range-value" id="customDifficultyValue">50</span>
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="customCategory" aria-label="Category">
                    <option value="extreme">Extreme (80-100)</option>
                    <option value="high">High (60-80)</option>
                    <option value="moderate" selected>Moderate (40-60)</option>
                    <option value="low">Low (0-40)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Instructions</label>
                <textarea class="form-textarea" id="customInstructions" placeholder="Detailed steps for completing this challenge..." aria-label="Instructions"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Identity Cue</label>
                <input type="text" class="form-input" id="customIdentity" placeholder="e.g., 'My voice commands attention'" aria-label="Identity Cue">
            </div>

            <div class="form-group">
                <label class="form-label">Reward Ritual</label>
                <input type="text" class="form-input" id="customReward" placeholder="e.g., 'Power pose + Victory shout'" aria-label="Reward Ritual">
            </div>

            <div class="form-group">
                <label class="form-label">Schedule</label>
                <div class="flex gap-2">
                    <label class="flex items-center gap-1">
                        <input type="checkbox" class="form-checkbox" id="scheduleDaily" aria-label="Schedule Daily">
                        Daily
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" class="form-checkbox" id="scheduleWeekly" aria-label="Schedule Weekly">
                        Weekly
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" class="form-checkbox" id="scheduleMonthly" aria-label="Schedule Monthly">
                        Monthly
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Base Points</label>
                <input type="number" class="form-input" id="customPoints" value="100" min="10" max="1000" aria-label="Base Points">
            </div>

            <div class="flex gap-2">
                <button class="btn btn-primary" onclick="app.saveCustomChallenge()" aria-label="Create Challenge">Create Challenge</button>
                <button class="btn btn-ghost" onclick="app.closeCustomChallengeModal()" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Emergency Protocol Modal -->
    <div class="modal-overlay" id="emergencyModal" role="dialog" aria-modal="true" aria-labelledby="emergencyModalTitle">
        <div class="modal" style="max-width: 600px; border-color: var(--danger);">
            <h2 id="emergencyModalTitle" style="color: var(--danger);">EMERGENCY STOP ACTIVATED</h2>
            <p class="text-secondary mb-3">Your safety is the absolute priority. All active sessions have been cleared.</p>
            <div class="safety-rules">
                <h4>IMMEDIATE STEPS:</h4>
                <ul>
                    <li><strong>Ground Yourself:</strong> Use the 5-4-3-2-1 technique (5 things you can see, 4 things you can touch, 3 things you can hear, 2 things you can smell, 1 thing you can taste).</li>
                    <li><strong>Contact Support:</strong> Reach out to your emergency contact or a trusted friend/family member.</li>
                    <li><strong>Professional Help:</strong> If you are in immediate danger, please contact emergency services or a crisis hotline.</li>
                </ul>
                <h4 class="mt-3">CRISIS RESOURCES:</h4>
                <ul>
                    <li><strong>National Suicide Prevention Lifeline:</strong> 988 (US)</li>
                    <li><strong>Crisis Text Line:</strong> Text HOME to 741741</li>
                    <li><strong>Your Emergency Contact:</strong> <span id="emergencyContactDisplay">Not set</span></li>
                </ul>
            </div>
            <p class="text-secondary mt-3">You will be blocked from heavy sessions for 48 hours. Please take care.</p>
            <div class="flex justify-end mt-4">
                <button class="btn btn-primary" onclick="app.closeEmergencyModal()">I Understand</button>
            </div>
        </div>
    </div>

    <!-- Smoke Test Report Modal -->
    <div class="modal-overlay" id="smokeTestModal" role="dialog" aria-modal="true" aria-labelledby="smokeTestTitle">
        <div class="modal" style="max-width: 700px;">
            <button class="modal-close" onclick="app.closeSmokeTestModal()" aria-label="Close Smoke Test Report"></button>
            <h2 id="smokeTestTitle" class="mb-3">Smoke Test Report</h2>
            <div id="smokeTestResults"></div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-primary" onclick="app.closeSmokeTestModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- DEV NOTES -->
    <div class="card mt-4 container" style="background: var(--bg-darker); border-color: var(--text-tertiary);">
        <div class="card-header">
            <h3 class="card-title" style="color: var(--text-secondary);">DEV NOTES (Constants to Tune)</h3>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('devNotesBody').classList.toggle('hidden')">Toggle</button>
        </div>
        <div class="card-body hidden" id="devNotesBody">
            <p><strong>DP_BASE_MICRO:</strong> Base points for micro sessions (default: 5)</p>
            <p><strong>DP_BASE_MEDIUM:</strong> Base points for medium sessions (default: 20)</p>
            <p><strong>DP_BASE_HEAVY:</strong> Base points for heavy sessions (default: 60)</p>
            <p><strong>DP_BONUS_CHANCE:</strong> Chance for variable-ratio bonus (default: 0.25)</p>
            <p><strong>DP_BONUS_MIN:</strong> Minimum variable-ratio bonus (default: 10)</p>
            <p><strong>DP_BONUS_MAX:</strong> Maximum variable-ratio bonus (default: 30)</p>
            <p><strong>DP_DAILY_CAP:</strong> Daily cap for DP earnings (default: 500)</p>
            <p><strong>SUDS_DROP_POINTS_MULTIPLIER:</strong> Points per SUDS drop (default: 2)</p>
            <p><strong>HEAVY_SESSION_LIMIT_WEEK:</strong> Max heavy sessions per week (default: 2)</p>
            <p><strong>HEAVY_SESSION_BLOCK_DAYS:</strong> Days to block heavy sessions after safety flag (default: 2)</p>
            <p><strong>DISSOCIATION_THRESHOLD_MIN:</strong> Dissociation duration for safety flag (default: 15)</p>
            <p><strong>WEEKLY_TARGETS:</strong> Defined in `routineTracker` for micro/medium/heavy sessions.</p>
            <p><strong>ROUTINE_TEMPLATES:</strong> Defined in `routineTracker` for daily schedule generation.</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // =====================================================
        // DEV NOTES (Constants to Tune)
        // =====================================================
        const DP_BASE_MICRO = 5;
        const DP_BASE_MEDIUM = 20;
        const DP_BASE_HEAVY = 60;
        const DP_BONUS_CHANCE = 0.25; // 25% chance for bonus
        const DP_BONUS_MIN = 10;
        const DP_BONUS_MAX = 30;
        const DP_DAILY_CAP = 500;
        const SUDS_DROP_POINTS_MULTIPLIER = 2;
        const HEAVY_SESSION_LIMIT_WEEK = 2;
        const HEAVY_SESSION_BLOCK_DAYS = 2; // Days to block heavy sessions after safety flag
        const DISSOCIATION_THRESHOLD_MIN = 15; // Minutes for dissociation safety flag

        // =====================================================
        // CORE DATA MODELS
        // =====================================================
        
        class Challenge {
            constructor(data) {
                this.id = data.id || `challenge_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                this.title = data.title;
                this.description = data.description || '';
                this.scientificExplanation = data.scientificExplanation || '';
                this.exactAction = data.exactAction || '';
                this.difficulty = data.difficulty; // 0-100
                this.category = data.category; // 'low', 'moderate', 'high', 'extreme'
                this.instructions = data.instructions;
                this.identityCue = data.identityCue;
                this.rewardRitual = data.rewardRitual;
                this.hasTimer = data.hasTimer || false;
                this.hasNotes = data.hasNotes || true;
                this.type = data.type || 'standard'; // 'micro', 'medium', 'heavy', 'custom', 'social', 'ego', etc.
                this.schedule = data.schedule || {};
                this.points = data.points || { base: 100, missPenalty: 20 };
                this.tags = data.tags || [];
                this.createdAt = data.createdAt || new Date().toISOString();
                this.isCustom = data.isCustom || false;
                this.neurochemicalHack = data.neurochemicalHack || '';
                this.microVariant = data.microVariant || '';
                this.safetyRules = data.safetyRules || [];
                this.sudsTarget = data.sudsTarget || {};
                this.kpi = data.kpi || '';
            }

            getDifficultyCategory() {
                if (this.difficulty >= 90) return 'extreme';
                if (this.difficulty >= 80) return 'high';
                if (this.difficulty >= 70) return 'moderate';
                return 'low';
            }

            getEstimatedTime() {
                // Estimate time based on type or difficulty
                if (this.type === 'micro') return 5;
                if (this.type === 'medium') return 15;
                if (this.type === 'heavy') return 30;
                return Math.ceil(this.difficulty / 10) * 5; // minutes
            }

            getNextDueDate() {
                const now = dayjs();
                if (this.schedule.daily) {
                    return now.add(1, 'day');
                }
                if (this.schedule.weekly) {
                    const daysUntilNext = (this.schedule.weekly.day - now.day() + 7) % 7 || 7;
                    return now.add(daysUntilNext, 'day');
                }
                if (this.schedule.monthly) {
                    return now.add(1, 'month').date(this.schedule.monthly.date);
                }
                return null;
            }
        }

        class Session {
            constructor(challenge, routineId = null) {
                this.id = `session_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                this.challengeId = challenge.id;
                this.challengeTitle = challenge.title;
                this.challengeType = challenge.type; // 'micro', 'medium', 'heavy' etc.
                this.routineId = routineId; // Link to routine item if applicable
                this.startTime = new Date();
                this.endTime = null;
                this.duration = 0;
                this.preSUDS = 0;
                this.postSUDS = 0;
                this.preMood = 50;
                this.postMood = 50;
                this.notes = '';
                this.completed = false;
                this.pointsEarned = 0;
                this.bonusPoints = 0;
                this.safetyFlags = {
                    suicidal: false,
                    dissociation: false,
                    panic: false,
                    ptsd: false,
                    violent: false
                };
                this.tags = challenge.tags || [];
            }

            complete(data) {
                this.endTime = new Date();
                this.duration = Math.floor((this.endTime - this.startTime) / 1000);
                this.postSUDS = data.postSUDS;
                this.postMood = data.postMood;
                this.notes = data.notes;
                this.safetyFlags = data.safetyFlags;
                this.completed = true;
                this.calculatePoints();
            }

            calculatePoints() {
                const challenge = app.getChallenge(this.challengeId);
                let basePoints = 0;
                switch (this.challengeType) {
                    case 'micro': basePoints = DP_BASE_MICRO; break;
                    case 'medium': basePoints = DP_BASE_MEDIUM; break;
                    case 'heavy': basePoints = DP_BASE_HEAVY; break;
                    default: basePoints = challenge.points.base; break;
                }
                
                let points = basePoints;
                
                // Difficulty bonus (for non-routine challenges)
                if (!this.routineId) {
                    points += Math.floor(challenge.difficulty / 10);
                }
                
                // SUDS drop bonus
                const sudsDrop = this.preSUDS - this.postSUDS;
                if (sudsDrop > 0) {
                    points += sudsDrop * SUDS_DROP_POINTS_MULTIPLIER;
                }
                
                // Time bonus (for longer sessions)
                if (this.duration > 300) { // More than 5 minutes
                    points += Math.floor(this.duration / 60);
                }
                
                // Mood improvement bonus
                const moodImprovement = this.postMood - this.preMood;
                if (moodImprovement > 0) {
                    points += moodImprovement;
                }
                
                // Variable-ratio bonus
                let bonus = 0;
                if (Math.random() < DP_BONUS_CHANCE) {
                    bonus = Math.floor(Math.random() * (DP_BONUS_MAX - DP_BONUS_MIN + 1)) + DP_BONUS_MIN;
                    points += bonus;
                }
                this.bonusPoints = bonus;

                // Apply multipliers
                if (app.state.activeMultiplier) {
                    points = Math.floor(points * app.state.activeMultiplier.value);
                }
                
                this.pointsEarned = points;
                return points;
            }
        }

        class ShopItem {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.description = data.description;
                this.cost = data.cost;
                this.icon = data.icon;
                this.type = data.type; // 'boost', 'cosmetic', 'utility', 'special'
                this.effect = data.effect;
                this.duration = data.duration;
                this.stackable = data.stackable || false;
                this.maxStack = data.maxStack || 1;
                this.purchased = 0;
            }

            canPurchase(points) {
                return points >= this.cost && (this.stackable || this.purchased === 0);
            }

            purchase() {
                this.purchased++;
                this.applyEffect();
            }

            applyEffect() {
                if (this.effect) {
                    this.effect();
                }
            }
        }

        class Achievement {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.description = data.description;
                this.icon = data.icon;
                this.category = data.category;
                this.condition = data.condition;
                this.reward = data.reward || 0;
                this.earned = false;
                this.earnedDate = null;
                this.progress = 0;
                this.maxProgress = data.maxProgress || 1;
            }

            check() {
                if (!this.earned && this.condition()) {
                    this.earn();
                }
            }

            earn() {
                this.earned = true;
                this.earnedDate = new Date().toISOString();
                app.state.dopaminePoints += this.reward;
                showNotification('Achievement Unlocked!', `${this.name} - +${this.reward} DP`, 'success');
                playSound('achievement');
            }

            updateProgress(value) {
                this.progress = Math.min(value, this.maxProgress);
                if (this.progress >= this.maxProgress) {
                    this.earn();
                }
            }
        }

        // Daily Routine Tracker Class
        class DailyRoutineTracker {
            constructor() {
                this.currentDate = dayjs(); // Track the currently displayed date
                this.dailyTemplate = {
                    "5:00": {
                        task: "Wake + Insult Protocol",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Start your day by confronting self-criticism head-on. This micro-exposure helps desensitize you to negative self-talk.",
                        scientificExplanation: "By voluntarily exposing yourself to self-insults, you create a prediction error. The brain expects a negative emotional response but receives a controlled, intentional one. This weakens the neural pathways associated with automatic negative self-judgment and strengthens prefrontal control over emotional responses. It's a form of cognitive defusion.",
                        instructions: "1. Stand in front of a mirror. 2. Say 3 'insults' about yourself (e.g., 'You're so clumsy', 'You're not smart enough'). 3. Immediately follow each with a genuine smile and a positive affirmation (e.g., '...and that's okay, I'm learning').",
                        exactAction: "Mirror work: 3 self-insults + smile + affirmation."
                    },
                    "5:15": {
                        task: "Rejection Collection (3 cold emails)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Actively seek out small rejections to build resilience and detach from outcome dependence.",
                        scientificExplanation: "Repeated, low-stakes exposure to rejection helps habituate the amygdala's fear response. Each 'no' becomes less threatening, reducing the cortisol spike and increasing the dopamine reward from simply taking action, regardless of the outcome. This rewires the brain to associate action with reward, not just success.",
                        instructions: "1. Identify 3 people or organizations you'd like to connect with but are unlikely to respond. 2. Send a brief, polite cold email requesting something (e.g., an informational interview, feedback on an idea). 3. Do not follow up. The goal is the 'no' or no response.",
                        exactAction: "Send 3 cold emails to unlikely respondents."
                    },
                    "5:30": {
                        task: "Boredom Sit (10 min)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Cultivate tolerance for stillness and lack of external stimulation, fostering internal creativity.",
                        scientificExplanation: "In an age of constant stimulation, boredom is often avoided. Embracing it allows the Default Mode Network (DMN) to activate, which is crucial for self-reflection, memory consolidation, and creative problem-solving. It trains the brain to generate its own stimulation rather than relying on external inputs, enhancing intrinsic motivation.",
                        instructions: "1. Find a quiet spot. 2. Set a timer for 10 minutes. 3. Sit without any distractions (phone, book, music, fidgeting). 4. Simply observe your thoughts and surroundings without judgment.",
                        exactAction: "Sit still for 10 minutes, no distractions."
                    },
                    "5:45": {
                        task: "Deep Work Block #1 (90 min frustration)",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Engage in a challenging task that guarantees some level of frustration, building mental fortitude.",
                        scientificExplanation: "Sustained engagement with frustrating tasks builds 'frustration tolerance' and grit. It strengthens the prefrontal cortex's ability to regulate emotions and persist through difficulty, rather than seeking immediate gratification or avoidance. Over time, the brain learns that persistence leads to mastery, reinforcing the effort-reward pathway.",
                        instructions: "1. Choose a complex task that requires deep concentration and is likely to cause some mental friction. 2. Eliminate all distractions. 3. Work on this task for 90 minutes, pushing through moments of frustration without giving up or switching tasks.",
                        exactAction: "90 minutes of deep, frustrating work on a complex task."
                    },
                    "7:15": {
                        task: "Shame Share (social media)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Publicly share a minor, imperfect aspect of yourself to desensitize shame and embrace authenticity.",
                        scientificExplanation: "Vulnerability, especially when it involves perceived imperfections, can be a powerful shame-buster. When you share something 'shameful' and are met with acceptance (or even indifference), it creates a prediction error that weakens the neural circuits associated with shame and strengthens those related to authenticity and self-acceptance. It's a form of exposure therapy for social anxiety.",
                        instructions: "1. Identify a minor, non-damaging 'imperfection' or embarrassing moment from your day/week. 2. Post about it on a social media platform where you have some audience (e.g., 'Just spilled coffee all over my shirt before a meeting, classic me!'). 3. Do not overthink or edit. Post and move on.",
                        exactAction: "Post a minor imperfection on social media."
                    },
                    "7:30": {
                        task: "Movement + Physical Rehab",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Engage in physical activity, especially focusing on areas of past injury or discomfort, to build resilience.",
                        scientificExplanation: "Physical activity, particularly when pushing through mild discomfort, releases endorphins and endocannabinoids, which are natural mood elevators and pain relievers. Addressing physical 'pain points' (rehab) builds a sense of agency and control over the body, reducing anxiety related to physical vulnerability. It reinforces the mind-body connection.",
                        instructions: "1. Perform 15-20 minutes of light to moderate exercise. 2. Include specific movements or stretches that target any areas of chronic stiffness or past injury, pushing gently into the discomfort.",
                        exactAction: "15-20 min exercise, focusing on physical discomfort areas."
                    },
                    "8:00": {
                        task: "Seduction Vulnerability (cold approach)",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Practice expressing genuine interest or admiration to a stranger, embracing the risk of social rejection.",
                        scientificExplanation: "This exercise targets social anxiety and fear of judgment, particularly in romantic or social contexts. The act of initiating a 'seductive' (i.e., genuinely interested) interaction, despite potential rejection, floods the brain with norepinephrine (from the risk) and, upon completion, a dopamine reward for taking action. It rewires the brain to associate social risk with growth, not just threat.",
                        instructions: "1. Identify someone you find attractive or interesting in a public setting (e.g., coffee shop, park). 2. Approach them and offer a genuine, non-creepy compliment or start a brief conversation. 3. The goal is not a date, but the act of expressing yourself and managing the outcome.",
                        exactAction: "Cold approach one person with a genuine compliment/conversation starter."
                    },
                    "8:30": {
                        task: "Work Block #2 (concentration strain)",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Another focused work block, specifically designed to push your concentration limits.",
                        scientificExplanation: "Similar to the frustration block, this builds mental endurance. Prolonged, intense concentration strengthens executive functions in the prefrontal cortex, improving working memory and attention span. It also increases the density of myelin, the 'insulation' around neurons, leading to faster and more efficient neural processing.",
                        instructions: "1. Choose another demanding task. 2. Work for 60-90 minutes with absolute focus, resisting the urge to check notifications or switch tasks. Use a timer.",
                        exactAction: "60-90 minutes of uninterrupted, high-concentration work."
                    },
                    "12:00": {
                        task: "Leadership Loneliness Lunch",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Eat lunch alone, intentionally disconnecting from social interaction to cultivate self-reliance and internal validation.",
                        scientificExplanation: "Voluntary solitude, especially during a typically social activity like lunch, can strengthen an individual's internal locus of control. It reduces reliance on external validation and social comparison, fostering a sense of self-sufficiency. This can lead to increased self-esteem and a clearer sense of personal values, which are hallmarks of effective leadership.",
                        instructions: "1. Eat your lunch alone, without your phone, a book, or any other distractions. 2. Observe your thoughts and feelings. Embrace the quiet and the feeling of being solely responsible for your own experience.",
                        exactAction: "Eat lunch alone, no devices, no distractions."
                    },
                    "13:00": {
                        task: "Rejection Harvest Hour",
                        type: "heavy",
                        level: "heavy",
                        points: DP_BASE_HEAVY,
                        description: "Dedicate an hour to actively seeking out various forms of rejection, from small to significant.",
                        scientificExplanation: "This is an intensified version of rejection collection. By systematically seeking out 'no's, you're actively desensitizing the brain's threat response to social and professional setbacks. The sheer volume of exposures helps to extinguish the fear, replacing it with a sense of accomplishment for simply taking action. It builds a robust 'rejection immune system'.",
                        instructions: "1. For one hour, engage in activities designed to elicit rejection. Examples: ask for discounts, pitch an ambitious idea, ask for a favor from a busy person, apply for a job you're underqualified for. 2. Track your 'no's. Celebrate each one as a win for courage.",
                        exactAction: "One hour of active rejection seeking (e.g., asking for 10 'no's)."
                    },
                    "14:00": {
                        task: "Creative Pain Session",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Engage in a creative endeavor with the explicit goal of producing something imperfect or 'bad'.",
                        scientificExplanation: "Perfectionism is a major block to creativity and action. By intentionally creating 'bad art' or unfinished work, you challenge the brain's reward system to decouple value from perfection. This reduces the fear of failure, increases psychological safety for experimentation, and ultimately fosters a more fluid and productive creative process. It's about valuing effort and process over flawless outcome.",
                        instructions: "1. Choose a creative medium (drawing, writing, music, coding). 2. For 30 minutes, create something with the explicit instruction to make it 'bad' or unfinished. Do not edit, refine, or judge. Just produce. 3. Share it with no one, or with a trusted friend who understands the exercise.",
                        exactAction: "30 minutes of intentionally 'bad' creative work."
                    },
                    "15:00": {
                        task: "Deep Work #3 (injustice acceptance)",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Confront a situation where you experience or observe injustice, and practice radical acceptance without immediate intervention.",
                        scientificExplanation: "This exercise builds emotional regulation and resilience to perceived unfairness. Instead of immediately reacting with anger or frustration (which can be dopamine-seeking in itself), you practice observing the injustice and accepting its existence without letting it hijack your emotional state. This strengthens the prefrontal cortex's ability to override impulsive emotional responses, fostering a more stoic and strategic mindset.",
                        instructions: "1. Identify a minor injustice (e.g., someone cutting in line, an unfair comment, a minor work slight). 2. Observe it. Acknowledge the feeling of injustice. 3. Consciously choose not to react or intervene immediately. Practice internal acceptance: 'This is happening. I can choose my response.' 4. Reflect on your emotional state before and after.",
                        exactAction: "Observe and accept a minor injustice without immediate reaction."
                    },
                    "17:00": {
                        task: "Family Boundary Practice",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Practice setting a small, clear boundary with a family member or close friend.",
                        scientificExplanation: "Setting boundaries, especially with loved ones, can be anxiety-provoking due to fear of conflict or disapproval. This micro-exposure strengthens the neural circuits associated with self-assertion and self-respect. Successfully setting a boundary, even a small one, provides a dopamine reward that reinforces the behavior, making it easier to set larger boundaries in the future. It's crucial for healthy relationships and self-esteem.",
                        instructions: "1. Identify a small, non-critical boundary you'd like to set (e.g., 'I can't talk right now, I'll call you back in 30 minutes' instead of taking the call immediately). 2. Clearly and calmly communicate this boundary to the person. 3. Do not over-explain or apologize excessively.",
                        exactAction: "Set one small, clear boundary with a family member/close friend."
                    },
                    "18:00": {
                        task: "Recovery Block",
                        type: "rest",
                        level: "rest",
                        points: 0,
                        description: "A dedicated period for active recovery and nervous system regulation.",
                        scientificExplanation: "Intense exposure work requires equally intense recovery. This block is designed to downregulate the sympathetic nervous system (fight-or-flight) and activate the parasympathetic nervous system (rest-and-digest). Activities like deep breathing, meditation, or gentle stretching reduce cortisol levels and promote neuroplasticity, allowing the brain to integrate the day's learnings and prepare for future challenges.",
                        instructions: "1. Engage in a restorative activity for 30-60 minutes. Examples: deep breathing exercises, progressive muscle relaxation, light stretching, listening to calming music, or a short meditation.",
                        exactAction: "30-60 minutes of active nervous system recovery."
                    },
                    "19:00": {
                        task: "Death Meditation",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "A brief meditation on your own mortality to cultivate urgency and appreciation for life.",
                        scientificExplanation: "Mortality salience, when approached constructively, can be a powerful motivator. Contemplating death activates brain regions associated with meaning-making and future planning. It can reduce procrastination and increase appreciation for the present moment, shifting focus from trivial concerns to what truly matters. This can lead to a 'carpe diem' effect, boosting motivation and reducing anxiety about minor setbacks.",
                        instructions: "1. Find a quiet space. 2. Close your eyes and spend 5-10 minutes contemplating your own mortality. Imagine your last day, your funeral, what you'd want to be remembered for. 3. Reflect on how this contemplation impacts your priorities and sense of urgency.",
                        exactAction: "5-10 minutes of mortality meditation."
                    },
                    "19:30": {
                        task: "Evening Protocols",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "A series of small, intentional actions to wind down and prepare for optimal sleep and next-day performance.",
                        scientificExplanation: "Consistent evening routines signal to the brain that it's time to transition from activity to rest. This helps regulate circadian rhythms and optimize sleep quality, which is critical for memory consolidation, emotional regulation, and overall cognitive function. These micro-actions, when consistently performed, create a positive feedback loop for well-being.",
                        instructions: "1. Turn off bright screens 30 minutes before bed. 2. Read a physical book or journal. 3. Prepare clothes/items for the next day. 4. Perform a quick gratitude exercise.",
                        exactAction: "Execute 3-4 pre-bed micro-actions (e.g., screen-off, read, prep, gratitude)."
                    },
                    "20:00": {
                        task: "Shadow Integration",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Acknowledge and integrate a 'shadow' aspect of yourself  a trait you typically suppress or judge.",
                        scientificExplanation: "Shadow work, derived from Jungian psychology, involves confronting and integrating disowned parts of the self. By consciously acknowledging a 'negative' trait (e.g., jealousy, anger, laziness) without judgment, you reduce its unconscious power. This frees up mental energy previously spent on suppression, leading to greater self-awareness, authenticity, and emotional wholeness. It reduces internal conflict and anxiety.",
                        instructions: "1. Identify a 'shadow' trait you dislike or suppress in yourself. 2. Write down how this trait might have served you in the past, or how it could be a distorted strength. 3. Acknowledge its presence without judgment: 'I am also [shadow trait], and that's part of me.'",
                        exactAction: "Identify and acknowledge one shadow trait, write its potential positive aspect."
                    },
                    "21:00": {
                        task: "Tracker Review + Tomorrow Setup",
                        type: "rest",
                        level: "rest",
                        points: 0,
                        description: "Review your day's progress and plan for tomorrow, reinforcing positive habits and learning from challenges.",
                        scientificExplanation: "This meta-cognitive activity strengthens the prefrontal cortex's role in self-regulation and planning. Reviewing successes provides a dopamine hit, reinforcing the day's efforts. Planning for tomorrow reduces decision fatigue and anxiety, freeing up cognitive resources. It creates a sense of closure for the day and proactive readiness for the next, optimizing performance and well-being.",
                        instructions: "1. Review your completed routines and challenges for the day. 2. Note any insights or areas for improvement. 3. Briefly outline your top 3 priorities or challenges for tomorrow.",
                        exactAction: "Review daily tracker, plan top 3 for tomorrow."
                    },
                    "10:00": {
                        task: "Self-Critical Reframing (15 min)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Actively challenge and reframe self-critical thoughts to break judgment loops.",
                        scientificExplanation: "Cognitive Behavioral Therapy (CBT) techniques like cognitive reframing directly target negative thought patterns. By consciously identifying self-critical thoughts and reinterpreting them from a more neutral or positive perspective, you weaken the neural pathways that perpetuate self-judgment and strengthen those associated with self-compassion and realistic self-assessment. This reduces anxiety and improves mood.",
                        instructions: "1. When a self-critical thought arises, write it down. 2. Ask: 'Is this 100% true? What's another way to look at this? What would I tell a friend?' 3. Reframe the thought into a more balanced or constructive statement. Repeat for 3-5 thoughts.",
                        exactAction: "Identify 3 self-critical thoughts, reframe each."
                    },
                    "11:00": {
                        task: "Identity Flexibility Practice (10 min)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Engage in an activity that challenges a self-limiting label you hold, promoting identity fluidity.",
                        scientificExplanation: "Neuroscience shows that self-labels can become deeply ingrained neural patterns. By intentionally acting 'out of character' or challenging a fixed identity, you create a prediction error that signals to the brain that these labels are not absolute. This promotes neuroplasticity, allowing for the formation of new, more adaptive self-concepts and reducing the rigidity of self-limiting beliefs.",
                        instructions: "1. Identify a self-limiting label (e.g., 'I'm not creative', 'I'm always late'). 2. For 10 minutes, engage in a small action that directly contradicts this label (e.g., doodle, arrive 5 min early for something, try a new recipe). 3. Observe the feeling of discomfort and the possibility of a new identity.",
                        exactAction: "10 min activity challenging a self-limiting label."
                    },
                    "16:00": {
                        task: "80% Rule Application (1 task)",
                        type: "medium",
                        level: "medium",
                        points: DP_BASE_MEDIUM,
                        description: "Consciously complete one task to 'good enough' (80%) standard, rather than striving for perfection.",
                        scientificExplanation: "Perfectionism is often driven by fear of failure and can lead to procrastination or burnout. Applying the '80% rule' (Pareto principle) helps to break this cycle. By intentionally stopping at 'good enough', you reduce the cognitive load and anxiety associated with perfection. This provides a dopamine reward for completion, reinforcing action and progress over unattainable ideals, and freeing up mental resources.",
                        instructions: "1. Choose a task you would normally try to perfect (e.g., writing an email, organizing a small space, preparing a report). 2. Set a timer for 70-80% of the time you'd normally spend. 3. Complete the task to a 'good enough' standard within that time. Resist the urge to polish further.",
                        exactAction: "Complete one task to 80% perfection, then stop."
                    },
                    "9:30": {
                        task: "Focus-Sprint Timer (25 min)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Utilize a Pomodoro-style timer for a focused work sprint, building execution discipline.",
                        scientificExplanation: "The Pomodoro Technique leverages time-boxing to enhance focus and prevent burnout. The short, intense bursts of work followed by breaks improve attention span and reduce mental fatigue. The consistent completion of these sprints provides regular dopamine hits, reinforcing the habit of focused work and building long-term execution discipline.",
                        instructions: "1. Choose a single task. 2. Set a timer for 25 minutes. 3. Work on that task with absolute focus, avoiding all distractions. 4. When the timer rings, take a 5-minute break. (For this routine, just complete one sprint).",
                        exactAction: "One 25-minute Pomodoro sprint on a single task."
                    },
                    "10:30": {
                        task: "Frustration Tolerance Micro-Exposure (5 min)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Engage in a small, intentionally frustrating activity to build patience and emotional regulation.",
                        scientificExplanation: "Similar to the longer frustration block, this micro-exposure is designed to incrementally increase your tolerance for discomfort and delay. By repeatedly exposing yourself to minor frustrations and choosing to persist rather than avoid, you strengthen the prefrontal cortex's ability to regulate the amygdala's 'fight or flight' response. This rewires the brain to perceive frustration as a signal for persistence, not panic.",
                        instructions: "1. Choose a small, mildly frustrating task (e.g., untangling a knot, solving a simple but annoying puzzle, trying to open a stubborn package). 2. Work on it for 5 minutes, consciously observing your frustration without giving up. 3. The goal is not to solve it, but to tolerate the feeling.",
                        exactAction: "5 minutes on a mildly frustrating task."
                    },
                    "11:30": {
                        task: "Imperfect Action Reps (3 reps)",
                        type: "micro",
                        level: "micro",
                        points: DP_BASE_MICRO,
                        description: "Perform three quick, imperfect actions where speed and completion are prioritized over polish.",
                        scientificExplanation: "This routine directly combats perfectionism and procrastination by emphasizing 'done is better than perfect'. Each rapid, imperfect completion provides a small dopamine reward, reinforcing the habit of taking action. It trains the brain to value momentum and progress, reducing the cognitive load and anxiety associated with starting tasks that feel overwhelming due to high standards.",
                        instructions: "1. Identify three small tasks you've been putting off due to perfectionism (e.g., sending a draft email, tidying a small corner, outlining an idea). 2. Complete each task as quickly and imperfectly as possible. The goal is to finish, not to make it perfect. 3. Move immediately from one to the next.",
                        exactAction: "Complete 3 small, imperfect actions rapidly."
                    }
                };
                
                // Weekly targets for enforcement
                this.weeklyTargets = {
                    micro: { min: 15, max: 21 }, // 3x daily micro for 5-7 days
                    medium: { min: 2, max: 4 }, // 2x medium per week
                    heavy: { min: 0, max: HEAVY_SESSION_LIMIT_WEEK } // 0-2 heavy per week
                };

                // 7-day rotation for daily intensity template
                // 0: Sunday, 1: Monday, ..., 6: Saturday
                this.intensityRotation = [
                    'rest',      // Sunday: Integration & Acceleration (lighter)
                    'extreme',   // Monday: EGO DEATH DAY
                    'high',      // Tuesday: APPROACH MASTERY DAY
                    'moderate',  // Wednesday: INSTANT ACTION DAY
                    'extreme',   // Thursday: HIERARCHY DESTRUCTION DAY
                    'high',      // Friday: MAXIMUM EXPOSURE DAY
                    'moderate'   // Saturday: SOCIAL DOMINANCE REVERSAL (medium)
                ];
            }
            
            /**
             * Formats a dayjs date object to a readable string.
             * @param {dayjs.Dayjs} date - The date to format.
             * @returns {string} Formatted date string.
             */
            formatDate(date) {
                return date.format('dddd, MMMM D, YYYY');
            }

            /**
             * Generates a unique key for storing daily routine data in localStorage.
             * @param {dayjs.Dayjs} date - The date for which to get the key.
             * @returns {string} The localStorage key.
             */
            getRoutineKey(date) {
                return `routine_${date.format('YYYY-MM-DD')}`;
            }

            /**
             * Determines the intensity template for a given date based on a 7-day rotation.
             * @param {dayjs.Dayjs} date - The date to get the template for.
             * @returns {string} 'extreme'|'high'|'moderate'|'rest'.
             */
            getTodayTemplate(date) {
                const dayOfWeek = date.day(); // 0 for Sunday, 1 for Monday, etc.
                return this.intensityRotation[dayOfWeek];
            }

            /**
             * Generates a full day's schedule based on the intensity template.
             * @param {dayjs.Dayjs} date - The date for which to generate the schedule.
             * @returns {Array<Object>} An array of routine items for the day.
             */
            generateScheduleFor(date) {
                const template = this.getTodayTemplate(date);
                const schedule = [];
                const availableRoutines = Object.values(this.dailyTemplate);

                let microCount = 0;
                let mediumCount = 0;
                let heavyCount = 0;

                // Base routines for all days
                const baseRoutines = [
                    this.dailyTemplate["5:00"], // Wake + Insult
                    this.dailyTemplate["5:30"], // Boredom Sit
                    this.dailyTemplate["12:00"], // Leadership Loneliness Lunch
                    this.dailyTemplate["18:00"], // Recovery Block
                    this.dailyTemplate["19:00"], // Death Meditation
                    this.dailyTemplate["19:30"], // Evening Protocols
                    this.dailyTemplate["20:00"], // Shadow Integration
                    this.dailyTemplate["21:00"]  // Tracker Review
                ];

                baseRoutines.forEach(r => {
                    if (r.level === 'micro') microCount++;
                    if (r.level === 'medium') mediumCount++;
                    if (r.level === 'heavy') heavyCount++;
                    schedule.push({ ...r, id: `routine_${date.format('YYYY-MM-DD')}_${r.task.replace(/\s/g, '_')}` });
                });

                // Add routines based on intensity template
                const addRoutine = (type, count, exclude = []) => {
                    const filtered = availableRoutines.filter(r => r.level === type && !exclude.includes(r.task));
                    for (let i = 0; i < count; i++) {
                        if (filtered.length > 0) {
                            const routine = filtered[Math.floor(Math.random() * filtered.length)];
                            schedule.push({ ...routine, id: `routine_${date.format('YYYY-MM-DD')}_${routine.task.replace(/\s/g, '_')}_${i}` });
                        }
                    }
                };

                switch (template) {
                    case 'extreme':
                        addRoutine('micro', 3 - microCount); // Ensure 3 micro
                        addRoutine('medium', 1);
                        addRoutine('heavy', 1); // One heavy session
                        break;
                    case 'high':
                        addRoutine('micro', 2 - microCount); // Ensure 2 micro
                        addRoutine('medium', 1);
                        break;
                    case 'moderate':
                        addRoutine('micro', 1 - microCount); // Ensure 1 micro
                        addRoutine('medium', 2);
                        break;
                    case 'rest':
                        // Only base routines and maybe one extra micro
                        addRoutine('micro', 1 - microCount);
                        break;
                }

                // Sort by time
schedule.sort((a, b) => {
    const timeA = (a && a.time) ? parseInt(a.time.replace(':', '')) : 9999;
    const timeB = (b && b.time) ? parseInt(b.time.replace(':', '')) : 9999;
    return timeA - timeB;
});


                // Assign unique IDs and initial status
                return schedule.map(item => ({
                    ...item,
                    routineId: item.id, // Use the generated ID as routineId
                    completed: false,
                    suds: { pre: 0, post: 0 },
                    notes: "",
                    safetyFlags: {
                        suicidal: false,
                        dissociation: false,
                        panic: false,
                        ptsd: false,
                        violent: false
                    }
                }));
            }

            /**
             * Seeds today's routine into localStorage if not already present.
             * This method is called when the user explicitly generates the routine.
             */
            seedTodaysRoutine() {
    const today = this.currentDate;
    const key = this.getRoutineKey(today);

    let stored;
    try {
        stored = JSON.parse(localStorage.getItem(key));
    } catch (e) {
        stored = null; // if JSON is corrupted or missing
    }

    // if nothing in storage OR corrupted OR missing routines, regenerate
    if (!stored || !stored.routines) {
        const routines = this.generateScheduleFor(today);
        stored = {
            date: today.toISOString(),
            focus: this.getTodayTemplate(today).toUpperCase() + " DAY",
            routines,
            stats: {
                completed: 0,
                total: routines.length,
                avgSudsReduction: 0,
                heavySessionsToday: 0
            }
        };
        localStorage.setItem(key, JSON.stringify(stored));
        showNotification(
            'Routine Generated!',
            `Today's ${stored.focus} schedule is ready.`,
            'success'
        );
    } else {
        showNotification(
            'Routine Already Exists',
            'Today\'s routine has already been generated.',
            'info'
        );
    }
}

            
            /**
             * Renders the daily schedule in the UI.
             */
            renderDailySchedule() {
                const scheduleDiv = document.getElementById('dailySchedule');
                const key = this.getRoutineKey(this.currentDate);
                let stored = JSON.parse(localStorage.getItem(key));
                
                if (!stored) {
                    // If no routine is stored for the day, generate a default one for display
                    // but don't save it unless explicitly generated by user
                    const routines = this.generateScheduleFor(this.currentDate);
                    stored = {
                        date: this.currentDate.toISOString(),
                        focus: this.getTodayTemplate(this.currentDate).toUpperCase() + " DAY",
                        routines,
                        stats: {
                            completed: 0,
                            total: routines.length,
                            avgSudsReduction: 0,
                            heavySessionsToday: 0
                        }
                    };
                }
                
                scheduleDiv.innerHTML = '';
                stored.routines.forEach((routine, index) => {
                    const item = document.createElement('div');
                    item.className = `routine-item ${routine.completed ? 'completed' : ''}`;
                    item.innerHTML = `
                        <div class="routine-time">${routine.time}</div>
                        <div class="routine-content">
                            <div class="routine-info">
                                <div class="routine-title">${routine.task}</div>
                                <div class="routine-meta">
                                    <span>Type: ${routine.type}</span>
                                    <span>Level: ${routine.level}</span>
                                    ${routine.completed ? 
                                        `<span>SUDS: ${routine.suds.pre}${routine.suds.post}</span>` : 
                                        ''
                                    }
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="stat-value" style="font-size: 1.2rem; color: gold;">+${routine.points} DP</span>
                                ${routine.completed ? 
                                    '<button class="btn btn-success btn-sm" disabled> Completed</button>' :
                                    `<button class="btn btn-primary btn-sm" onclick="app.openRoutineDetailModal('${routine.routineId}')">Complete</button>`
                                }
                            </div>
                        </div>
                    `;
                    scheduleDiv.appendChild(item);
                });
                
                // Update stats display
                const completionRate = stored.stats.total > 0 ? Math.round((stored.stats.completed / stored.stats.total) * 100) : 0;
                const statsDisplay = document.createElement('div');
                statsDisplay.className = 'card mt-2';
                statsDisplay.innerHTML = `
                    <div class="card-body">
                        <h4>Today's Stats</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Completion</div>
                                <div class="stat-value">${completionRate}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Completed</div>
                                <div class="stat-value">${stored.stats.completed}/${stored.stats.total}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg SUDS Drop</div>
                                <div class="stat-value">${stored.stats.avgSudsReduction}%</div>
                            </div>
                        </div>
                    </div>
                `;
                scheduleDiv.appendChild(statsDisplay);
                
                // Update date
                document.getElementById('routineDate').textContent = this.formatDate(this.currentDate);

                // Disable/enable prev/next day buttons
                const today = dayjs().startOf('day');
                const displayedDate = this.currentDate.startOf('day');

                document.getElementById('prevDayRoutine').disabled = (displayedDate.diff(today, 'day') <= -7); // Limit to 7 days back
                document.getElementById('nextDayRoutine').disabled = (displayedDate.diff(today, 'day') >= 7); // Limit to 7 days forward
            }

            /**
             * Marks a routine item as completed and updates stats.
             * @param {string} routineId - The unique ID of the routine item.
             * @param {Object} sudsData - { pre: number, post: number }
             * @param {string} notes - User notes for the routine.
             * @param {Object} safetyFlags - Safety flags selected by the user.
             */
            markCompleted(routineId, sudsData, notes, safetyFlags) {
                const key = this.getRoutineKey(this.currentDate);
                const stored = JSON.parse(localStorage.getItem(key));
                
                if (stored) {
                    const routineIndex = stored.routines.findIndex(r => r.routineId === routineId);
                    if (routineIndex !== -1) {
                        const routine = stored.routines[routineIndex];
                        routine.completed = true;
                        routine.suds = sudsData;
                        routine.notes = notes;
                        routine.safetyFlags = safetyFlags;

                        // Check for safety flags and block heavy sessions if needed
                        if (Object.values(safetyFlags).some(flag => flag)) {
                            app.state.heavySessionBlockedUntil = dayjs().add(HEAVY_SESSION_BLOCK_DAYS, 'day').toISOString();
                            app.emergencyProtocol(true); // Trigger emergency modal without full stop
                        }

                        // Update daily stats
                        stored.stats.completed++;
                        if (routine.type === 'heavy') {
                            stored.stats.heavySessionsToday = (stored.stats.heavySessionsToday || 0) + 1;
                        }
                        
                        // Calculate average SUDS reduction for the day
                        const completedWithSuds = stored.routines.filter(r => 
                            r.completed && r.suds.pre > 0 && r.suds.post > 0
                        );
                        if (completedWithSuds.length > 0) {
                            const totalReduction = completedWithSuds.reduce((sum, r) => 
                                sum + (r.suds.pre - r.suds.post), 0
                            );
                            stored.stats.avgSudsReduction = Math.round(totalReduction / completedWithSuds.length);
                        }
                        
                        localStorage.setItem(key, JSON.stringify(stored));
                        app.saveState(); // Save app state to persist heavySessionBlockedUntil
                    }
                }
                this.updateProgressUI();
            }
            
            /**
             * Aggregates routine and session data for the last 7 days.
             * @returns {Object} Summary of micro, medium, heavy sessions.
             */
            getWeekSummary() {
                const summary = {
                    micro: 0,
                    medium: 0,
                    heavy: 0,
                    sudsDrops: [],
                    heavySessionsThisWeek: 0
                };
                const today = dayjs();
                const startOfWeek = today.startOf('isoWeek'); // Monday

                for (let i = 0; i < 7; i++) {
                    const date = startOfWeek.add(i, 'day');
                    const key = this.getRoutineKey(date);
                    const stored = JSON.parse(localStorage.getItem(key));

                    if (stored) {
                        stored.routines.forEach(routine => {
                            if (routine.completed) {
                                summary[routine.type] = (summary[routine.type] || 0) + 1;
                                if (routine.suds.pre > 0 && routine.suds.post > 0) {
                                    summary.sudsDrops.push(routine.suds.pre - routine.suds.post);
                                }
                                if (routine.type === 'heavy') {
                                    summary.heavySessionsThisWeek++;
                                }
                            }
                        });
                    }
                    // Also count sessions from app.state.sessions that are not routine-based
                    app.state.sessions.filter(s => 
                        dayjs(s.startTime).isSame(date, 'day') && !s.routineId && s.completed
                    ).forEach(session => {
                        summary[session.challengeType] = (summary[session.challengeType] || 0) + 1;
                        if (session.preSUDS > 0 && session.postSUDS > 0) {
                            summary.sudsDrops.push(session.preSUDS - session.postSUDS);
                        }
                        if (session.challengeType === 'heavy') {
                            summary.heavySessionsThisWeek++;
                        }
                    });
                }
                return summary;
            }

            /**
             * Updates the progress bars and other UI elements in the Routine tab.
             */
            updateProgressUI() {
                const weekSummary = this.getWeekSummary();
                const { micro, medium, heavy } = weekSummary;

                // Update micro progress
                const microTarget = this.weeklyTargets.micro.max;
                const microProgress = Math.min(micro, microTarget);
                const microPercent = (microProgress / microTarget) * 100;
                document.getElementById('microProgressFill').style.width = `${microPercent}%`;
                document.getElementById('microProgressLabel').textContent = `${microProgress}/${microTarget}`;

                // Update medium progress
                const mediumTarget = this.weeklyTargets.medium.max;
                const mediumProgress = Math.min(medium, mediumTarget);
                const mediumPercent = (mediumProgress / mediumTarget) * 100;
                document.getElementById('mediumProgressFill').style.width = `${mediumPercent}%`;
                document.getElementById('mediumProgressLabel').textContent = `${mediumProgress}/${mediumTarget}`;

                // Update heavy progress
                const heavyTarget = this.weeklyTargets.heavy.max;
                const heavyProgress = Math.min(heavy, heavyTarget);
                const heavyPercent = (heavyProgress / heavyTarget) * 100;
                document.getElementById('heavyProgressFill').style.width = `${heavyPercent}%`;
                document.getElementById('heavyProgressLabel').textContent = `${heavyProgress}/${heavyTarget}`;

                // Update dashboard avg SUDS drop
                if (weekSummary.sudsDrops.length > 0) {
                    const avgSudsDrop = Math.round(weekSummary.sudsDrops.reduce((a, b) => a + b, 0) / weekSummary.sudsDrops.length);
                    document.getElementById('avgSudsDrop').textContent = `${avgSudsDrop}%`;
                } else {
                    document.getElementById('avgSudsDrop').textContent = `0%`;
                }

                // Update charts
                app.renderWeeklyProgressChart();
                app.renderSudsProgressChart();
                app.renderChallengeDistributionChart();
                app.renderMonthlyHeatmap();
            }

            /**
             * Changes the currently displayed day in the routine tracker.
             * @param {number} offset - Number of days to offset from the current date.
             */
            changeDay(offset) {
                this.currentDate = this.currentDate.add(offset, 'day');
                this.renderDailySchedule();
            }
        }

        // Initialize tracker
        const routineTracker = new DailyRoutineTracker();

        // =====================================================
        // APPLICATION STATE
        // =====================================================
        
        const app = {
            state: {
                // User Profile
                userId: localStorage.getItem('userId') || generateUserId(),
                displayName: localStorage.getItem('displayName') || 'Warrior',
                avatar: localStorage.getItem('avatar') || '',
                bio: localStorage.getItem('bio') || '',
                
                // Stats
                totalChallenges: 0,
                completedChallenges: 0,
                currentStreak: 0,
                bestStreak: 0,
                dopaminePoints: 0,
                dopaminePointsToday: 0, // Track daily DP for cap
                lastDopamineResetDate: dayjs().format('YYYY-MM-DD'),
                level: 1,
                experience: 0,
                totalTime: 0,
                totalDopamineEarned: 0,
                
                // Session Data
                currentSession: null,
                sessions: [], // Stores all completed sessions
                
                // Settings
                theme: 'dark',
                notifications: true,
                soundEnabled: true,
                reminderTime: '09:00',
                
                // Active Effects
                activeMultiplier: null,
                activeBoosts: [],
                streakProtection: 0,
                timeWarps: 0,
                challengeSkips: 0,
                avatarFrame: 'default',
                
                // Social
                friends: [],
                friendRequests: [],
                
                // Emergency
                emergencyContact: {},
                heavySessionBlockedUntil: null, // ISO string date
                
                // Today's challenges (from general challenges tab, not routine)
                todaysChallenges: []
            },
            
            challenges: [],
            shopItems: [],
            achievements: [],
            
            // Chart instances
            weeklyProgressChartInstance: null,
            sudsProgressChartInstance: null,
            challengeDistributionChartInstance: null,

            init() {
                this.loadState();
                this.initializeChallenges();
                this.initializeShop();
                this.initializeAchievements();
                this.setupEventListeners();
                this.updateUI();
                this.checkScheduledChallenges();
                this.startPeriodicChecks();
                
                // Initialize routine tracker and render
                routineTracker.currentDate = dayjs(); // Ensure current date is today on init
                routineTracker.renderDailySchedule();
                routineTracker.updateProgressUI();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.remove('active');
                }, 1000);

                // Initial safety reminder
                setTimeout(() => {
                    showNotification(
                        'Safety First', 
                        'Remember: RED FLAGS = STOP IMMEDIATELY. Your well-being comes before any challenge.',
                        'warning'
                    );
                }, 3000);
            },
            
            loadState() {
                const savedState = localStorage.getItem('appState');
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        Object.assign(this.state, parsed);
                        // Ensure dayjs objects are re-initialized if needed
                        if (this.state.lastDopamineResetDate) {
                            this.state.lastDopamineResetDate = dayjs(this.state.lastDopamineResetDate).format('YYYY-MM-DD');
                        }
                    } catch (e) {
                        console.error('Failed to load state:', e);
                    }
                }
                
                // Load challenges
                const savedChallenges = localStorage.getItem('challenges');
                if (savedChallenges) {
                    try {
                        const parsed = JSON.parse(savedChallenges);
                        this.challenges = parsed.map(c => new Challenge(c));
                    } catch (e) {
                        console.error('Failed to load challenges:', e);
                    }
                }
                
                // Apply theme
                if (this.state.theme === 'light') {
                    document.body.classList.add('light-mode');
                    document.getElementById('themeIcon').textContent = '';
                }

                // Reset daily DP cap if date changed
                if (this.state.lastDopamineResetDate !== dayjs().format('YYYY-MM-DD')) {
                    this.state.dopaminePointsToday = 0;
                    this.state.lastDopamineResetDate = dayjs().format('YYYY-MM-DD');
                }
            },
            
            saveState() {
                localStorage.setItem('appState', JSON.stringify(this.state));
                localStorage.setItem('challenges', JSON.stringify(this.challenges));
            },
            
            initializeChallenges() {
                if (this.challenges.length === 0) {
                    // Initialize with ALL 34 pain transformation challenges from plan.md
                    const defaultChallenges = [
                        // EXTREME INTENSITY (90-98%)
                        {
                            title: "EGO DEATH",
                            difficulty: 98,
                            category: "extreme",
                            instructions: "Micro: Publicly ask 'stupid' questions in expert forums. Small: Admit you're wrong when you're actually right. Medium: Let someone inferior teach you something basic. Heavy: Prostrate/bow to someone you consider beneath you",
                            identityCue: "My ego death births infinite power",
                            rewardRitual: "Ground touch + roar 'EGO IS ILLUSION!' (12s)",
                            neurochemicalHack: "Ego dissolution triggers massive dopamine rebound through prediction error - brain expects shame, receives liberation.",
                            microVariant: "Say 'I don't know' when you do know",
                            hasTimer: true,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false }, // Not daily for general challenges
                            points: { base: DP_BASE_HEAVY, missPenalty: 40 },
                            tags: ['ego', 'transformation', 'extreme'],
                            safetyRules: ["Stop if depersonalization >2hrs", "Therapist: 'Ego work triggering identity crisis'"],
                            sudsTarget: { start: 95, week3: 50 },
                            kpi: "28 ego deaths/week"
                        },
                        {
                            title: "COLD APPROACH MASTERY",
                            difficulty: 98,
                            category: "extreme",
                            instructions: "Micro: Approach 5 strangers for time. Small: Approach 10 people for opinions. Medium: Approach attractive people for conversation. Heavy: Approach intimidating authority figures",
                            identityCue: "Every approach makes me legendary",
                            rewardRitual: "Chest pound + 'I AM UNSTOPPABLE!' (10s)",
                            neurochemicalHack: "Pre-approach: 20 jumping jacks (adrenaline spike)  approach  immediate reward. Hijacks fight-or-flight into approach response.",
                            microVariant: "Wave at 10 strangers",
                            hasTimer: true,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_HEAVY, missPenalty: 35 },
                            tags: ['social', 'courage', 'approach'],
                            safetyRules: ["Stop if stalking behavior emerges", "Therapist: 'Approach addiction forming'"],
                            sudsTarget: { start: 95, week2: 40 },
                            kpi: "210 approaches/week"
                        },
                        {
                            title: "HESITATION ANNIHILATION",
                            difficulty: 98,
                            category: "extreme",
                            instructions: "Micro: 3-2-1 GO rule - act within 3 seconds. Small: First thought = immediate action (10 reps). Medium: Make major decision in <10 seconds. Heavy: Act on scariest impulse immediately",
                            identityCue: "I move at the speed of instinct",
                            rewardRitual: "Snap fingers + 'HESITATION IS DEATH!' (8s)",
                            neurochemicalHack: "Count '3-2-1' triggers norepinephrine  action triggers dopamine. Creates automatic action response.",
                            microVariant: "Send text without rereading",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_HEAVY, missPenalty: 30 },
                            tags: ['action', 'speed', 'instinct'],
                            safetyRules: ["Stop if reckless endangerment occurs", "Therapist: 'Impulsivity becoming dangerous'"],
                            sudsTarget: { start: 90, week1: 30 },
                            kpi: "350 instant actions/week"
                        },
                        {
                            title: "SUPERIORITY COMPLEX DISSOLUTION",
                            difficulty: 95,
                            category: "extreme",
                            instructions: "Micro: Find 3 ways someone 'inferior' is superior. Small: Ask 'lesser' person for advice publicly. Medium: Work under someone less qualified. Heavy: Serve someone you look down on for full day",
                            identityCue: "I learn from every human equally",
                            rewardRitual: "Kneel gesture + 'ALL ARE MY TEACHERS!' (15s)",
                            neurochemicalHack: "Superiority release  oxytocin flood from connection  dopamine from unexpected learning.",
                            microVariant: "Compliment someone you judge",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 1 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 30 },
                            tags: ['humility', 'ego', 'growth'],
                            safetyRules: ["Stop if severe depression emerges", "Therapist: 'Superiority work causing self-hatred'"],
                            sudsTarget: { start: 85, week4: 60 },
                            kpi: "7 superiority dissolutions/week"
                        },
                        {
                            title: "ARROGANCE TRIGGER TRANSFORMATION",
                            difficulty: 92,
                            category: "extreme",
                            instructions: "Micro: Thank arrogant person genuinely. Small: Compliment arrogant person's expertise. Medium: Learn from arrogant person for 1hr. Heavy: Partner with most arrogant person you know",
                            identityCue: "Others' arrogance polishes my mirror",
                            rewardRitual: "Head bow + 'ARROGANCE TEACHES HUMILITY!' (12s)",
                            neurochemicalHack: "Arrogance encounter  immediate reframe as teacher  gratitude practice. Converts cortisol spike into oxytocin.",
                            microVariant: "Smile at arrogant behavior",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 3 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 25 },
                            tags: ['acceptance', 'growth', 'social'],
                            safetyRules: ["Stop if violent fantasies emerge", "Therapist: 'Arrogance triggering rage issues'"],
                            sudsTarget: { start: 85, week3: 55 },
                            kpi: "7 arrogance transformations/week"
                        },
                        {
                            title: "REJECTION COLLECTION",
                            difficulty: 95,
                            category: "extreme",
                            instructions: "Micro: Ask for small favors expecting 'no'. Small: Apply to 3 stretch opportunities daily. Medium: Pitch ambitious ideas to decision-makers. Heavy: Ask for 50% raise or major promotion",
                            identityCue: "Rejection proves I'm playing big",
                            rewardRitual: "Victory clap sequence (5 claps) + 'NO feeds my YES' (8s)",
                            neurochemicalHack: "Each rejection triggers reward prediction error when celebrated, rewiring rejection from pain to gain.",
                            microVariant: "Ask for unreasonable discount at coffee shop",
                            hasTimer: true,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_HEAVY, missPenalty: 30 },
                            tags: ['rejection', 'courage', 'growth'],
                            safetyRules: ["Stop if self-harm ideation after rejection", "Escalation: 'Rejection work triggering self-destruction'"],
                            sudsTarget: { start: 90, week2: 45 },
                            kpi: "70 rejections/week"
                        },
                        {
                            title: "INSULT/DISRESPECT TRAINING",
                            difficulty: 98,
                            category: "extreme",
                            instructions: "Micro: Write 3 insults about yourself daily, smile after each. Small: Record yourself reading them aloud. Medium: Share minor vulnerability in group. Heavy: Pitch bad idea to harsh critics",
                            identityCue: "Disrespect feeds my unstoppable engine",
                            rewardRitual: "10 explosive pushups + shout 'FUEL!' (15s)",
                            neurochemicalHack: "Converting cortisol to dopamine through immediate physical celebration.",
                            microVariant: "Write one self-criticism, delete after reading",
                            hasTimer: true,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_HEAVY, missPenalty: 35 },
                            tags: ['insult', 'resilience', 'extreme'],
                            safetyRules: ["Stop if dissociation >30min", "Stop if revenge fantasies persist"],
                            sudsTarget: { start: 95, week4: 70 },
                            kpi: "21 deliberate disrespect exposures/week"
                        },
                        {
                            title: "SEDUCTION VULNERABILITY",
                            difficulty: 97,
                            category: "extreme",
                            instructions: "Micro: 2min eye contact with attractive person in video. Small: Cold approach 1 person for directions. Medium: Compliment 3 strangers genuinely. Heavy: Ask someone for coffee date",
                            identityCue: "Vulnerability is my power display",
                            rewardRitual: "Cold water face splash + 'I am magnetic chaos' (20s)",
                            neurochemicalHack: "Sexual vulnerability reduces shame circuits while increasing confidence pathways.",
                            microVariant: "30s mirror eye contact with seductive expression",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 5 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 30 },
                            tags: ['intimacy', 'vulnerability', 'attraction'],
                            safetyRules: ["Stop if stalking thoughts emerge", "Stop if obsessive patterns develop"],
                            sudsTarget: { start: 90, week4: 65 },
                            kpi: "7 seduction exposures/week"
                        },
                        {
                            title: "ROMANTIC/LOVE EXPRESSION",
                            difficulty: 96,
                            category: "extreme",
                            instructions: "Micro: Write love letter to self, read aloud. Small: Text genuine appreciation to 3 people. Medium: Share deep feeling with friend/family. Heavy: Express romantic interest explicitly",
                            identityCue: "My love is infinite and fearless",
                            rewardRitual: "Heart-tap rhythm (10 taps) + 'Love flows through me' (10s)",
                            neurochemicalHack: "Love expression increases oxytocin and dopamine simultaneously, creating powerful bonding-reward loops.",
                            microVariant: "Send heart emoji to someone you appreciate",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_HEAVY, missPenalty: 28 },
                            tags: ['love', 'expression', 'connection'],
                            safetyRules: ["Stop if manic love-bombing behaviors emerge", "Escalation: 'Love exposure creating dependency'"],
                            sudsTarget: { start: 88, week3: 60 },
                            kpi: "7 love expressions daily"
                        },
                        {
                            title: "SHAME EXPOSURE",
                            difficulty: 92,
                            category: "extreme",
                            instructions: "Micro: Share minor embarrassing fact daily. Small: Post imperfect work publicly. Medium: Admit significant mistake to peer group. Heavy: Public speaking about personal failure",
                            identityCue: "My shame becomes my strength",
                            rewardRitual: "Power stance 15s + 'Shame is my teacher' (20s)",
                            neurochemicalHack: "Voluntary shame exposure reduces shame's power through habituation, converting it from inhibitor to motivator.",
                            microVariant: "Text typo to important contact, don't correct",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 2 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 25 },
                            tags: ['vulnerability', 'courage', 'authenticity'],
                            safetyRules: ["Stop if shame spirals last >2 hours", "Escalation: 'Shame work causing persistent self-hatred'"],
                            sudsTarget: { start: 88, week2: 50 },
                            kpi: "14 shame exposures/week"
                        },
                        {
                            title: "DEATH/MORTALITY MEDITATION",
                            difficulty: 94,
                            category: "extreme",
                            instructions: "Micro: 5min mortality meditation daily. Small: Write goodbye letter to loved one (don't send). Medium: Visit cemetery, sit with impermanence 30min. Heavy: Have end-of-life conversation with family",
                            identityCue: "Mortality fuels my urgency",
                            rewardRitual: "Deep breath hold 20s + 'Death makes now precious' (30s)",
                            neurochemicalHack: "Mortality salience increases meaning-making circuits and present-moment awareness.",
                            microVariant: "Look at old photo, acknowledge impermanence",
                            hasTimer: true,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 0 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 25 },
                            tags: ['mortality', 'meaning', 'presence'],
                            safetyRules: ["Stop if suicidal ideation emerges", "Escalation: 'Death exposure triggering dark thoughts'"],
                            sudsTarget: { start: 90, week4: 70 },
                            kpi: "7 mortality meditations/week"
                        },
                        
                        // HIGH INTENSITY (80-89%)
                        {
                            title: "BETRAYAL REFRAME",
                            difficulty: 88,
                            category: "high",
                            instructions: "Micro: Recall past betrayal, find the lesson. Small: Share valuable info with competitor. Medium: Trust someone with minor secret. Heavy: Delegate critical task completely",
                            identityCue: "Betrayal sharpens my judgment",
                            rewardRitual: "Chest pound 2x + 'Betrayal reveals truth' (10s)",
                            neurochemicalHack: "Reframing betrayal as data collection activates learning circuits instead of threat detection.",
                            microVariant: "Share small win with potential rival",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 5 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 20 },
                            tags: ['trust', 'wisdom', 'resilience'],
                            safetyRules: ["Stop if paranoid thoughts persist >24hrs", "Escalation: 'Trust exercises creating paranoia'"],
                            sudsTarget: { start: 80, week3: 45 },
                            kpi: "7 trust exercises/week"
                        },
                        {
                            title: "FRUSTRATION WITH HARD PROBLEMS",
                            difficulty: 88,
                            category: "high",
                            instructions: "Micro: Attempt unsolvable puzzle 15min. Small: Work on hardest task when tired. Medium: Tackle problem outside expertise. Heavy: Commit to impossible deadline",
                            identityCue: "Hard problems forge my genius",
                            rewardRitual: "Neck roll + 'Frustration means growth' (15s)",
                            neurochemicalHack: "Sustained cognitive load increases BDNF production, literally growing new neural connections.",
                            microVariant: "Try expert-level sudoku for 5min",
                            hasTimer: true,
                            type: "medium", // Changed to medium for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 18 },
                            tags: ['cognitive', 'persistence', 'growth'],
                            safetyRules: ["Stop if rage or object destruction occurs", "Escalation: 'Problem frustration triggering violence'"],
                            sudsTarget: { start: 85, week2: 40 },
                            kpi: "14 frustration sessions/week"
                        },
                        {
                            title: "INJUSTICE ACCEPTANCE",
                            difficulty: 88,
                            category: "high",
                            instructions: "Micro: Accept unfair treatment without protest. Small: Take blame for other's mistake. Medium: Let someone take credit for your work. Heavy: Support opponent's unfair advantage",
                            identityCue: "I transcend all injustice",
                            rewardRitual: "Jaw clench-release + 'Injustice tests character' (12s)",
                            neurochemicalHack: "Accepting injustice without attachment activates stoic neural patterns, reducing amygdala reactivity.",
                            microVariant: "Let someone cut in line",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 2 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 20 },
                            tags: ['acceptance', 'stoicism', 'character'],
                            safetyRules: ["Stop if victim mentality persists >48hrs", "Escalation: 'Injustice work creating learned helplessness'"],
                            sudsTarget: { start: 82, week3: 50 },
                            kpi: "7 injustice acceptances/week"
                        },
                        {
                            title: "LEADERSHIP LONELINESS",
                            difficulty: 85,
                            category: "high",
                            instructions: "Micro: Eat lunch alone, no devices. Small: Make unpopular decision publicly. Medium: Skip social event for vision work. Heavy: Take stand that isolates you",
                            identityCue: "Loneliness confirms my leadership",
                            rewardRitual: "Crown tap (top of head) + 'Alone at the top' (10s)",
                            neurochemicalHack: "Voluntary isolation strengthens internal locus of control, increasing dopamine from self-generated rewards.",
                            microVariant: "Decide without consulting anyone",
                            hasTimer: true,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 4 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 15 },
                            tags: ['leadership', 'solitude', 'vision'],
                            safetyRules: ["Stop if isolation exceeds 72hrs continuous", "Escalation: 'Leadership isolation creating depression'"],
                            sudsTarget: { start: 80, week2: 45 },
                            kpi: "7 leadership isolations/week"
                        },
                        {
                            title: "BOREDOM PRACTICE",
                            difficulty: 90,
                            category: "high",
                            instructions: "Micro: Sit still 10min, no stimulation. Small: 30min mundane task, no multitasking. Medium: 2hr block, no screens/books/music. Heavy: Full day minimal stimulation retreat",
                            identityCue: "Empty space creates everything",
                            rewardRitual: "Temple tap 3x + 'Boredom births brilliance' (10s)",
                            neurochemicalHack: "Boredom forces default mode network activation, crucial for creativity and insight generation.",
                            microVariant: "Stare at wall for 2 minutes",
                            hasTimer: true,
                            type: "medium", // Changed to medium for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 15 },
                            tags: ['mindfulness', 'creativity', 'patience'],
                            safetyRules: ["Stop if dissociation or panic emerges", "Escalation: 'Boredom creating disconnection from reality'"],
                            sudsTarget: { start: 75, week2: 35 },
                            kpi: "7 boredom sessions/week"
                        },
                        
                        // MODERATE INTENSITY (70-79%)
                        {
                            title: "FINANCIAL LOSS ACCEPTANCE",
                            difficulty: 78,
                            category: "moderate",
                            instructions: "Micro: Tip 50% at coffee shop. Small: Invest $100 in high-risk venture. Medium: Give away valuable possession. Heavy: Take calculated 10% portfolio risk",
                            identityCue: "Money flows through me freely",
                            rewardRitual: "Money gesture (fingers rub) + 'Loss creates flow' (8s)",
                            neurochemicalHack: "Voluntary financial loss reduces scarcity mindset, paradoxically increasing abundance neural patterns.",
                            microVariant: "Buy stranger's coffee",
                            hasTimer: false,
                            type: "micro", // Changed to micro for routine
                            schedule: { monthly: { date: 15 } },
                            points: { base: DP_BASE_MICRO, missPenalty: 12 },
                            tags: ['abundance', 'detachment', 'generosity'],
                            safetyRules: ["Stop if gambling urges emerge", "Escalation: 'Financial exposure triggering addiction'"],
                            sudsTarget: { start: 70, week3: 40 },
                            kpi: "4 financial losses/month"
                        },
                        {
                            title: "ISOLATION IN GREATNESS",
                            difficulty: 78,
                            category: "moderate",
                            instructions: "Micro: Excel without sharing achievement. Small: Succeed without seeking validation. Medium: Major win, tell no one for week. Heavy: Build in secret for months",
                            identityCue: "I am my only audience",
                            rewardRitual: "Silent nod + 'Greatness needs no witness' (10s)",
                            neurochemicalHack: "Internal validation strengthens intrinsic motivation circuits, reducing dependence on external dopamine hits.",
                            microVariant: "Complete task excellently, tell no one",
                            hasTimer: false,
                            type: "micro", // Changed to micro for routine
                            schedule: { weekly: { day: 6 } },
                            points: { base: DP_BASE_MICRO, missPenalty: 10 },
                            tags: ['self-validation', 'excellence', 'intrinsic'],
                            safetyRules: ["Stop if disconnection from reality occurs", "Escalation: 'Isolation creating delusion'"],
                            sudsTarget: { start: 70, week2: 35 },
                            kpi: "7 isolation practices/week"
                        },
                        {
                            title: "HEAVY CONCENTRATION STRAIN",
                            difficulty: 75,
                            category: "moderate",
                            instructions: "Micro: Focus 25min without break. Small: 90min deep work block. Medium: 4hr uninterrupted focus. Heavy: 8hr marathon session",
                            identityCue: "Mental strain expands limits",
                            rewardRitual: "Eye palm press + 'Strain builds capacity' (15s)",
                            neurochemicalHack: "Extended focus increases myelin production, literally speeding up neural transmission.",
                            microVariant: "Read dense text for 10min straight",
                            hasTimer: true,
                            type: "medium", // Changed to medium for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 10 },
                            tags: ['focus', 'discipline', 'mental-strength'],
                            safetyRules: ["Stop if headaches persist >24hrs", "Escalation: 'Concentration causing physical symptoms'"],
                            sudsTarget: { start: 70, week1: 25 },
                            kpi: "14 concentration sessions/week"
                        },
                        {
                            title: "CREATIVE PAIN",
                            difficulty: 70,
                            category: "moderate",
                            instructions: "Micro: Create bad art for 15min. Small: Share unfinished work. Medium: Publish without editing. Heavy: Display worst creation publicly",
                            identityCue: "Creative pain precedes breakthrough",
                            rewardRitual: "Hand shake + 'Bad art births brilliance' (10s)",
                            neurochemicalHack: "Producing 'bad' work reduces perfectionism circuits, increasing creative flow state probability.",
                            microVariant: "Draw with non-dominant hand",
                            hasTimer: true,
                            type: "micro", // Changed to micro for routine
                            schedule: { weekly: { day: 0 } },
                            points: { base: DP_BASE_MICRO, missPenalty: 8 },
                            tags: ['creativity', 'vulnerability', 'expression'],
                            safetyRules: ["Stop if creative paralysis exceeds 1 week", "Escalation: 'Creative exposure blocking all output'"],
                            sudsTarget: { start: 65, week2: 30 },
                            kpi: "7 creative pain sessions/week"
                        },
                        
                        // LOW INTENSITY (60-69%)
                        {
                            title: "SENSORY OVERLOAD TRAINING",
                            difficulty: 65,
                            category: "low",
                            instructions: "Micro: Loud environment work 30min. Small: Multiple screens + audio. Medium: Crowded space focus 2hrs. Heavy: Sensory chaos marathon",
                            identityCue: "I find calm in chaos",
                            rewardRitual: "Ear press + 'Chaos sharpens focus' (10s)",
                            neurochemicalHack: "Sensory overload training increases selective attention networks, improving focus amid distraction.",
                            microVariant: "Work with TV on for 10min",
                            hasTimer: true,
                            type: "micro", // Changed to micro for routine
                            schedule: { weekly: { day: 3 } },
                            points: { base: DP_BASE_MICRO, missPenalty: 5 },
                            tags: ['focus', 'adaptability', 'sensory'],
                            safetyRules: ["Stop if migraines develop", "Escalation: 'Sensory work causing medical symptoms'"],
                            sudsTarget: { start: 60, week2: 25 },
                            kpi: "7 sensory sessions/week"
                        },
                        {
                            title: "SHADOW TEMPTATION INTEGRATION",
                            difficulty: 60,
                            category: "low",
                            instructions: "Micro: Acknowledge dark thought without judgment. Small: Write out shadow desire. Medium: Discuss shadow with trusted friend. Heavy: Channel shadow into creative work",
                            identityCue: "My shadow serves my light",
                            rewardRitual: "Shadow boxing move + 'Shadow integrated' (10s)",
                            neurochemicalHack: "Shadow integration reduces unconscious energy drain, freeing prefrontal resources for conscious goals.",
                            microVariant: "Name the shadow impulse aloud",
                            hasTimer: false,
                            type: "micro", // Changed to micro for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MICRO, missPenalty: 5 },
                            tags: ['shadow-work', 'integration', 'self-awareness'],
                            safetyRules: ["Stop if acting on harmful impulses", "Escalation: 'Shadow work releasing dangerous impulses'"],
                            sudsTarget: { start: 55, week1: 20 },
                            kpi: "7 shadow integrations daily"
                        },
                        {
                            title: "ETHICAL EDGE EXPLORATION",
                            difficulty: 45,
                            category: "low",
                            instructions: "Micro: Small white lie for efficiency. Small: Prioritize self over group. Medium: Competitive advantage taking. Heavy: Calculated ethical boundary push",
                            identityCue: "I define my own morality",
                            rewardRitual: "Center touch + 'Ethics evolve' (8s)",
                            neurochemicalHack: "Ethical edge work clarifies personal values through contrast, strengthening moral identity.",
                            microVariant: "Take last cookie",
                            hasTimer: false,
                            type: "micro", // Changed to micro for routine
                            schedule: { monthly: { date: 1 } },
                            points: { base: DP_BASE_MICRO, missPenalty: 3 },
                            tags: ['ethics', 'boundaries', 'self-discovery'],
                            safetyRules: ["Stop if illegal activity considered", "Escalation: 'Ethical work destroying moral compass'"],
                            sudsTarget: { start: 45, week2: 20 },
                            kpi: "4 ethical explorations/month"
                        },
                        
                        // Additional challenges to complete the 34
                        {
                            title: "FAMILY DISAPPOINTMENT PRACTICE",
                            difficulty: 85,
                            category: "high",
                            instructions: "Micro: Disagree with family tradition. Small: Skip family event for personal growth. Medium: Make career choice against family wishes. Heavy: Set firm boundary with toxic relative",
                            identityCue: "Disappointing others proves my authenticity",
                            rewardRitual: "Chest tap + 'I choose my path' (10s)",
                            neurochemicalHack: "Breaking family patterns activates individuation circuits, strengthening personal identity.",
                            microVariant: "Say no to small family request",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 0 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 15 },
                            tags: ['family', 'boundaries', 'authenticity'],
                            safetyRules: ["Stop if family cut-off considered", "Escalation: 'Family work destroying relationships'"],
                            sudsTarget: { start: 80, week3: 50 },
                            kpi: "7 boundary settings/week"
                        },
                        {
                            title: "FAILURE CELEBRATION",
                            difficulty: 80,
                            category: "high",
                            instructions: "Micro: Celebrate small mistake publicly. Small: Share failure story on social media. Medium: Host 'failure party' for recent loss. Heavy: Give speech about biggest failure",
                            identityCue: "My failures are my medals",
                            rewardRitual: "Victory arms + 'FAILURE IS DATA!' (10s)",
                            neurochemicalHack: "Celebrating failure rewires shame circuits, converting failure from punishment to reward signal.",
                            microVariant: "Post about today's mistake",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 5 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 12 },
                            tags: ['failure', 'celebration', 'reframe'],
                            safetyRules: ["Stop if masochistic patterns emerge", "Escalation: 'Failure celebration becoming self-sabotage'"],
                            sudsTarget: { start: 75, week2: 40 },
                            kpi: "7 failure celebrations/week"
                        },
                        {
                            title: "PHYSICAL DISCOMFORT TRAINING",
                            difficulty: 75,
                            category: "moderate",
                            instructions: "Micro: Cold shower 30s. Small: Uncomfortable position 5min. Medium: Fast for 24hrs. Heavy: Extreme temperature exposure 30min",
                            identityCue: "Discomfort is my comfort zone",
                            rewardRitual: "Body shake + 'PAIN IS POWER!' (10s)",
                            neurochemicalHack: "Physical discomfort increases pain tolerance and releases endorphins, creating natural high.",
                            microVariant: "Hold ice cube for 30s",
                            hasTimer: true,
                            type: "micro", // Changed to micro for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MICRO, missPenalty: 8 },
                            tags: ['physical', 'discomfort', 'resilience'],
                            safetyRules: ["Stop if medical symptoms emerge", "Escalation: 'Physical training causing injury'"],
                            sudsTarget: { start: 70, week1: 30 },
                            kpi: "14 discomfort sessions/week"
                        },
                        {
                            title: "SOCIAL MEDIA VULNERABILITY",
                            difficulty: 82,
                            category: "high",
                            instructions: "Micro: Post unflattering photo. Small: Share personal struggle publicly. Medium: Live stream without preparation. Heavy: Document failure in real-time",
                            identityCue: "My vulnerability is my brand",
                            rewardRitual: "Phone raise + 'AUTHENTIC CHAOS!' (10s)",
                            neurochemicalHack: "Public vulnerability increases social connection and reduces impression management fatigue.",
                            microVariant: "Post with typo, don't edit",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 15 },
                            tags: ['social-media', 'vulnerability', 'authenticity'],
                            safetyRules: ["Stop if cyberbullying occurs", "Escalation: 'Social exposure causing online harassment'"],
                            sudsTarget: { start: 78, week2: 40 },
                            kpi: "7 vulnerable posts daily"
                        },
                        {
                            title: "COMPETENCE QUESTIONING",
                            difficulty: 87,
                            category: "high",
                            instructions: "Micro: Ask basic question in expert meeting. Small: Admit knowledge gap to colleague. Medium: Request training in your specialty area. Heavy: Publicly acknowledge someone junior knows more",
                            identityCue: "Questions reveal my wisdom",
                            rewardRitual: "Head tap + 'LEARNING NEVER STOPS!' (10s)",
                            neurochemicalHack: "Competence questioning activates growth mindset circuits, increasing neuroplasticity.",
                            microVariant: "Google something basic publicly",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 3 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 18 },
                            tags: ['competence', 'humility', 'learning'],
                            safetyRules: ["Stop if job security threatened", "Escalation: 'Competence work affecting career'"],
                            sudsTarget: { start: 83, week3: 50 },
                            kpi: "14 competence questions/week"
                        },
                        {
                            title: "ABANDONMENT TRIGGER WORK",
                            difficulty: 91,
                            category: "extreme",
                            instructions: "Micro: Initiate temporary separation. Small: Be first to end conversation. Medium: Take solo trip without contact. Heavy: End toxic relationship permanently",
                            identityCue: "I am whole alone",
                            rewardRitual: "Self-hug + 'I AM ENOUGH!' (15s)",
                            neurochemicalHack: "Abandonment exposure reduces attachment anxiety, strengthening secure attachment patterns.",
                            microVariant: "Leave group chat for day",
                            hasTimer: false,
                            type: "heavy", // Changed to heavy for routine
                            schedule: { weekly: { day: 4 } },
                            points: { base: DP_BASE_HEAVY, missPenalty: 22 },
                            tags: ['abandonment', 'attachment', 'independence'],
                            safetyRules: ["Stop if self-harm urges emerge", "Escalation: 'Abandonment work triggering crisis'"],
                            sudsTarget: { start: 88, week4: 60 },
                            kpi: "7 abandonment practices/week"
                        },
                        {
                            title: "MONEY SHAME EXPOSURE",
                            difficulty: 83,
                            category: "high",
                            instructions: "Micro: Discuss salary openly. Small: Admit financial mistake publicly. Medium: Ask for money owed. Heavy: Negotiate aggressively for value",
                            identityCue: "Money flows to the shameless",
                            rewardRitual: "Wallet tap + 'ABUNDANCE FLOWS!' (10s)",
                            neurochemicalHack: "Money shame exposure reduces scarcity programming, increasing abundance mindset.",
                            microVariant: "Share exact bank balance with friend",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 1 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 14 },
                            tags: ['money', 'shame', 'abundance'],
                            safetyRules: ["Stop if financial recklessness emerges", "Escalation: 'Money work creating dangerous decisions'"],
                            sudsTarget: { start: 79, week2: 45 },
                            kpi: "7 money conversations/week"
                        },
                        {
                            title: "PERFORMANCE ANXIETY EXPOSURE",
                            difficulty: 89,
                            category: "high",
                            instructions: "Micro: Sing/dance in public briefly. Small: Perform skill you're bad at. Medium: Give unprepared presentation. Heavy: Public performance of new skill",
                            identityCue: "My performance is my gift",
                            rewardRitual: "Bow gesture + 'I GIVE MY ART!' (10s)",
                            neurochemicalHack: "Performance exposure reduces perfectionism, increasing creative expression and flow states.",
                            microVariant: "Hum in elevator with others",
                            hasTimer: true,
                            type: "medium", // Changed to medium for routine
                            schedule: { weekly: { day: 6 } },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 20 },
                            tags: ['performance', 'anxiety', 'expression'],
                            safetyRules: ["Stop if panic attack occurs", "Escalation: 'Performance exposure causing severe anxiety'"],
                            sudsTarget: { start: 85, week3: 50 },
                            kpi: "7 performances/week"
                        },
                        {
                            title: "CONTROL SURRENDER",
                            difficulty: 86,
                            category: "high",
                            instructions: "Micro: Let others order for you. Small: Delegate important task fully. Medium: Let someone else plan your day. Heavy: Give someone temporary life decision power",
                            identityCue: "Surrender amplifies my power",
                            rewardRitual: "Arms spread + 'I RELEASE CONTROL!' (10s)",
                            neurochemicalHack: "Control surrender reduces anxiety circuits, increasing trust and collaborative capacity.",
                            microVariant: "Let coin flip decide lunch",
                            hasTimer: false,
                            type: "medium", // Changed to medium for routine
                            schedule: { daily: false },
                            points: { base: DP_BASE_MEDIUM, missPenalty: 16 },
                            tags: ['control', 'surrender', 'trust'],
                            safetyRules: ["Stop if helplessness emerges", "Escalation: 'Control work creating paralysis'"],
                            sudsTarget: { start: 82, week2: 45 },
                            kpi: "7 control surrenders daily"
                        }
                    ];
                    
                    this.challenges = defaultChallenges.map(c => new Challenge(c));
                }
            },
            
            initializeShop() {
                this.shopItems = [
                    new ShopItem({
                        id: 'multiplier_2x',
                        name: '2X Points Multiplier',
                        description: 'Double your points for the next hour',
                        cost: 500,
                        icon: '',
                        type: 'boost',
                        duration: 3600000, // 1 hour
                        effect: () => {
                            this.state.activeMultiplier = {
                                value: 2,
                                endTime: dayjs().add(1, 'hour').valueOf()
                            };
                            showNotification('Boost Activated!', '2X Points for 1 hour!', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'streak_protection',
                        name: 'Streak Protection',
                        description: 'Protect your streak from one missed day',
                        cost: 300,
                        icon: '',
                        type: 'utility',
                        stackable: true,
                        maxStack: 3,
                        effect: () => {
                            this.state.streakProtection = (this.state.streakProtection || 0) + 1;
                            showNotification('Protected!', 'Your streak is safe for one miss', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'instant_level',
                        name: 'Instant Level Up',
                        description: 'Immediately advance to the next level',
                        cost: 1000,
                        icon: '',
                        type: 'special',
                        effect: () => {
                            this.levelUp();
                            showNotification('Level Up!', `You are now Level ${this.state.level}!`, 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'challenge_reroll',
                        name: 'Challenge Reroll',
                        description: 'Get a new set of daily challenges',
                        cost: 100,
                        icon: '',
                        type: 'utility',
                        stackable: true,
                        effect: () => {
                            this.rerollDailyChallenges();
                            showNotification('Rerolled!', 'New challenges available!', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'golden_avatar',
                        name: 'Golden Avatar Frame',
                        description: 'Show off your dedication with a golden frame',
                        cost: 2000,
                        icon: '',
                        type: 'cosmetic',
                        effect: () => {
                            this.state.avatarFrame = 'golden';
                            this.updateAvatarDisplay();
                            showNotification('Golden!', 'You now have a golden avatar frame!', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'time_warp',
                        name: 'Time Warp',
                        description: 'Complete any challenge instantly',
                        cost: 750,
                        icon: '',
                        type: 'special',
                        stackable: true,
                        maxStack: 5,
                        effect: () => {
                            this.state.timeWarps = (this.state.timeWarps || 0) + 1;
                            showNotification('Time Warp!', 'Use on any active challenge', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'dopamine_surge',
                        name: 'Dopamine Surge',
                        description: 'Instant 100 DP bonus',
                        cost: 200,
                        icon: '',
                        type: 'boost',
                        stackable: true,
                        effect: () => {
                            this.state.dopaminePoints += 100;
                            this.updateUI();
                            showNotification('Surge!', '+100 Dopamine Points!', 'success');
                        }
                    }),
                    new ShopItem({
                        id: 'challenge_skip',
                        name: 'Challenge Skip',
                        description: 'Skip a challenge without penalty',
                        cost: 150,
                        icon: '',
                        type: 'utility',
                        stackable: true,
                        maxStack: 10,
                        effect: () => {
                            this.state.challengeSkips = (this.state.challengeSkips || 0) + 1;
                            showNotification('Skip Available!', 'Use on any scheduled challenge', 'success');
                        }
                    })
                ];
            },
            
            initializeAchievements() {
                this.achievements = [
                    new Achievement({
                        id: 'first_challenge',
                        name: 'First Step',
                        description: 'Complete your first challenge',
                        icon: '',
                        category: 'beginner',
                        condition: () => this.state.completedChallenges >= 1,
                        reward: 50
                    }),
                    new Achievement({
                        id: 'week_warrior',
                        name: 'Week Warrior',
                        description: 'Maintain a 7-day streak',
                        icon: '',
                        category: 'streak',
                        condition: () => this.state.currentStreak >= 7,
                        reward: 200
                    }),
                    new Achievement({
                        id: 'month_master',
                        name: 'Month Master',
                        description: 'Maintain a 30-day streak',
                        icon: '',
                        category: 'streak',
                        condition: () => this.state.currentStreak >= 30,
                        reward: 1000
                    }),
                    new Achievement({
                        id: 'dopamine_rich',
                        name: 'Dopamine Rich',
                        description: 'Earn 10,000 total DP',
                        icon: '',
                        category: 'points',
                        condition: () => this.state.totalDopamineEarned >= 10000,
                        reward: 500
                    }),
                    new Achievement({
                        id: 'level_10',
                        name: 'Double Digits',
                        description: 'Reach Level 10',
                        icon: '',
                        category: 'level',
                        condition: () => this.state.level >= 10,
                        reward: 300
                    }),
                    new Achievement({
                        id: 'extreme_conqueror',
                        name: 'Extreme Conqueror',
                        description: 'Complete 10 extreme challenges',
                        icon: '',
                        category: 'difficulty',
                        condition: () => {
                            const extremeCompleted = this.state.sessions.filter(s => {
                                const challenge = this.getChallenge(s.challengeId);
                                return challenge && challenge.category === 'extreme' && s.completed;
                            }).length;
                            return extremeCompleted >= 10;
                        },
                        reward: 750
                    }),
                    new Achievement({
                        id: 'ego_death_master',
                        name: 'Ego Death Master',
                        description: 'Complete 50 ego death challenges',
                        icon: '',
                        category: 'transformation',
                        condition: () => {
                            const egoCompleted = this.state.sessions.filter(s => {
                                const challenge = this.getChallenge(s.challengeId);
                                return challenge && challenge.title.includes('EGO DEATH') && s.completed;
                            }).length;
                            return egoCompleted >= 50;
                        },
                        reward: 1000
                    }),
                    new Achievement({
                        id: 'approach_legend',
                        name: 'Approach Legend',
                        description: 'Complete 100 cold approaches',
                        icon: '',
                        category: 'social',
                        condition: () => {
                            const approachCompleted = this.state.sessions.filter(s => {
                                const challenge = this.getChallenge(s.challengeId);
                                return challenge && challenge.title.includes('APPROACH') && s.completed;
                            }).length;
                            return approachCompleted >= 100;
                        },
                        reward: 800
                    }),
                    new Achievement({
                        id: 'rejection_collector',
                        name: 'Rejection Collector',
                        description: 'Collect 500 rejections',
                        icon: '',
                        category: 'rejection',
                        condition: () => {
                            const rejectionCompleted = this.state.sessions.filter(s => {
                                const challenge = this.getChallenge(s.challengeId);
                                return challenge && challenge.title.includes('REJECTION') && s.completed;
                            }).length;
                            return rejectionCompleted >= 500;
                        },
                        reward: 1500
                    }),
                    new Achievement({
                        id: 'shadow_integrator',
                        name: 'Shadow Integrator',
                        description: 'Complete all shadow work challenges',
                        icon: '',
                        category: 'shadow',
                        condition: () => {
                            const shadowCompleted = this.state.sessions.filter(s => {
                                const challenge = this.getChallenge(s.challengeId);
                                return challenge && challenge.title.includes('SHADOW') && s.completed;
                            }).length;
                            return shadowCompleted >= 30;
                        },
                        reward: 600
                    })
                ];
            },
            
            getChallenge(id) {
                return this.challenges.find(c => c.id === id);
            },
            
            /**
             * Starts a new challenge session.
             * @param {string} challengeId - The ID of the challenge to start.
             * @param {string|null} routineId - The ID of the routine item if this is part of a daily routine.
             */
            startSession(challengeId, routineId = null) {
                const challenge = this.getChallenge(challengeId);
                if (!challenge) return;

                // Check if heavy session is blocked
                if (challenge.type === 'heavy' && this.state.heavySessionBlockedUntil && dayjs().isBefore(dayjs(this.state.heavySessionBlockedUntil))) {
                    showNotification('Heavy Session Blocked', `Heavy sessions are blocked until ${dayjs(this.state.heavySessionBlockedUntil).format('MMM D, HH:mm')}. Please focus on recovery.`, 'danger');
                    return;
                }
                
                this.state.currentSession = new Session(challenge, routineId);
                
                // Update modal with challenge details
                document.getElementById('sessionTitle').textContent = challenge.title;
                document.getElementById('identityPhrase').textContent = challenge.identityCue;
                document.getElementById('protocolSteps').innerHTML = `
                    <div><strong>Instructions:</strong> ${challenge.instructions}</div>
                    <div style="margin-top: 1rem;"><strong>Reward Ritual:</strong> ${challenge.rewardRitual}</div>
                    ${challenge.neurochemicalHack ? `<div style="margin-top: 1rem;"><strong>Neurochemical Hack:</strong> ${challenge.neurochemicalHack}</div>` : ''}
                    ${challenge.microVariant ? `<div style="margin-top: 1rem;"><strong>Micro Variant:</strong> ${challenge.microVariant}</div>` : ''}
                    ${challenge.safetyRules && challenge.safetyRules.length > 0 ? `<div style="margin-top: 1rem; color: var(--warning);"><strong>Safety Rules:</strong><ul>${challenge.safetyRules.map(rule => `<li>${rule}</li>`).join('')}</ul></div>` : ''}
                `;
                
                // Reset SUDS/Mood sliders and notes
                document.getElementById('sudsSlider').value = 50;
                document.getElementById('sudsValue').textContent = 50;
                document.getElementById('moodSlider').value = 50;
                document.getElementById('moodValue').textContent = 'Neutral';
                document.getElementById('sessionNotes').value = '';
                document.getElementById('noteCharCount').textContent = 0;
                // Reset safety flags
                document.getElementById('safetyFlagSuicidal').checked = false;
                document.getElementById('safetyFlagDissociation').checked = false;
                document.getElementById('safetyFlagPanic').checked = false;
                document.getElementById('safetyFlagPTSD').checked = false;
                document.getElementById('safetyFlagViolent').checked = false;

                // Show modal
                document.getElementById('sessionModal').classList.add('active');
                
                // Start timer if applicable
                if (challenge.hasTimer) {
                    this.startTimer();
                }

                // Log pre-SUDS
                this.state.currentSession.preSUDS = parseInt(document.getElementById('sudsSlider').value);
                this.state.currentSession.preMood = parseInt(document.getElementById('moodSlider').value);
                
                showNotification('Challenge Started!', 'Transform your discomfort into power!', 'success');
                playSound('start');
            },
            
            startTimer() {
                this.state.timerInterval = setInterval(() => {
                    if (!this.state.currentSession) return;
                    
                    const elapsed = dayjs().diff(dayjs(this.state.currentSession.startTime), 'second');
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    
                    document.getElementById('timerDisplay').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            },
            
            pauseTimer() {
                clearInterval(this.state.timerInterval);
            },
            
            completeSession() {
                if (!this.state.currentSession) return;

                // Collect safety flags
                const safetyFlags = {
                    suicidal: document.getElementById('safetyFlagSuicidal').checked,
                    dissociation: document.getElementById('safetyFlagDissociation').checked,
                    panic: document.getElementById('safetyFlagPanic').checked,
                    ptsd: document.getElementById('safetyFlagPTSD').checked,
                    violent: document.getElementById('safetyFlagViolent').checked
                };

                // If any safety flag is checked, trigger emergency protocol
                if (Object.values(safetyFlags).some(flag => flag)) {
                    this.emergencyProtocol(true); // Pass true to indicate it's from a session completion
                    return; // Stop session completion
                }
                
                this.state.currentSession.complete({
                    postSUDS: parseInt(document.getElementById('sudsSlider').value),
                    postMood: parseInt(document.getElementById('moodSlider').value),
                    notes: document.getElementById('sessionNotes').value,
                    safetyFlags: safetyFlags
                });
                
                // Update stats, respecting daily DP cap
                let pointsEarned = this.state.currentSession.pointsEarned;
                if (this.state.dopaminePointsToday + pointsEarned > DP_DAILY_CAP) {
                    pointsEarned = DP_DAILY_CAP - this.state.dopaminePointsToday;
                    if (pointsEarned < 0) pointsEarned = 0; // Ensure points don't go negative if already over cap
                    showNotification('DP Cap Reached', `You've hit your daily DP cap! Earned ${pointsEarned} DP.`, 'warning');
                }
                
                this.state.completedChallenges++;
                this.state.totalChallenges++;
                this.state.dopaminePoints += pointsEarned;
                this.state.dopaminePointsToday += pointsEarned;
                this.state.totalDopamineEarned = (this.state.totalDopamineEarned || 0) + pointsEarned;
                this.state.currentStreak++;
                if (this.state.currentStreak > this.state.bestStreak) {
                    this.state.bestStreak = this.state.currentStreak;
                }
                this.state.totalTime += this.state.currentSession.duration;
                
                // Check for level up
                this.checkLevelUp();
                
                // Check achievements
                this.checkAchievements();
                
                // Save session
                this.state.sessions.push(this.state.currentSession);
                
                // If this was a routine item, mark it completed in the routine tracker
                if (this.state.currentSession.routineId) {
                    routineTracker.markCompleted(
                        this.state.currentSession.routineId,
                        { pre: this.state.currentSession.preSUDS, post: this.state.currentSession.postSUDS },
                        this.state.currentSession.notes,
                        this.state.currentSession.safetyFlags
                    );
                }
                
                // Show reward modal
                this.showReward(pointsEarned);
                
                // Clear timer
                clearInterval(this.state.timerInterval);
                
                // Save state
                this.saveState();
                
                // Update UI
                this.updateUI();
                routineTracker.updateProgressUI();
            },
            
            checkLevelUp() {
                const requiredXP = this.state.level * 1000;
                if (this.state.dopaminePoints >= requiredXP) {
                    this.levelUp();
                }
            },
            
            levelUp() {
                this.state.level++;
                this.state.experience = 0;
                showNotification('LEVEL UP!', `You are now Level ${this.state.level}!`, 'success');
                playSound('levelup');
            },
            
            checkAchievements() {
                this.achievements.forEach(achievement => {
                    if (!achievement.earned) {
                        achievement.check();
                    }
                });
            },
            
            showReward(pointsEarned) {
                const session = this.state.currentSession;
                document.getElementById('rewardPoints').textContent = pointsEarned;
                document.getElementById('rewardSudsDrop').textContent = 
                    `${session.preSUDS - session.postSUDS}%`;
                document.getElementById('rewardTime').textContent = 
                    `${Math.floor(session.duration / 60)}m`;
                document.getElementById('rewardBonus').textContent = session.bonusPoints;
                
                document.getElementById('sessionModal').classList.remove('active');
                document.getElementById('rewardModal').classList.add('active');
                playSound('complete');
            },
            
            checkScheduledChallenges() {
                const today = dayjs();
                
                // Clear previous today's challenges
                this.state.todaysChallenges = [];

                this.challenges.forEach(challenge => {
                    let shouldAdd = false;
                    if (challenge.schedule.daily) {
                        // Check if completed today
                        const todayCompleted = this.state.sessions.some(s => {
                            return s.challengeId === challenge.id &&
                                   dayjs(s.startTime).isSame(today, 'day') &&
                                   s.completed;
                        });
                        if (!todayCompleted) {
                            shouldAdd = true;
                        }
                    } else if (challenge.schedule.weekly && challenge.schedule.weekly.day === today.day()) {
                        // Check if completed this week
                        const weekCompleted = this.state.sessions.some(s => {
                            return s.challengeId === challenge.id &&
                                   dayjs(s.startTime).isSame(today, 'week') &&
                                   s.completed;
                        });
                        if (!weekCompleted) {
                            shouldAdd = true;
                        }
                    } else if (challenge.schedule.monthly && challenge.schedule.monthly.date === today.date()) {
                        // Check if completed this month
                        const monthCompleted = this.state.sessions.some(s => {
                            return s.challengeId === challenge.id &&
                                   dayjs(s.startTime).isSame(today, 'month') &&
                                   s.completed;
                        });
                        if (!monthCompleted) {
                            shouldAdd = true;
                        }
                    }
                    
                    if (shouldAdd) {
                        this.state.todaysChallenges.push(challenge.id);
                    }
                });
            },
            
            rerollDailyChallenges() {
                // Shuffle and pick new daily challenges
                const shuffled = [...this.challenges].sort(() => Math.random() - 0.5);
                this.state.todaysChallenges = shuffled.slice(0, 5).map(c => c.id);
                this.updateUI();
            },
            
            updateAvatarDisplay() {
                const avatar = document.getElementById('userAvatar');
                if (this.state.avatarFrame === 'golden') {
                    avatar.style.border = '3px solid gold';
                    avatar.style.boxShadow = '0 0 20px gold';
                }
            },
            
            startPeriodicChecks() {
                // Check for scheduled challenges every hour
                setInterval(() => {
                    this.checkScheduledChallenges();
                }, 3600000);
                
                // Check for multiplier expiry every minute
                setInterval(() => {
                    if (this.state.activeMultiplier && dayjs().valueOf() > this.state.activeMultiplier.endTime) {
                        this.state.activeMultiplier = null;
                        showNotification('Boost Expired', 'Points multiplier has ended', 'warning');
                    }
                }, 60000);
                
                // Auto-save every 5 minutes
                setInterval(() => {
                    this.saveState();
                }, 300000);

                // Daily DP cap reset check
                setInterval(() => {
                    if (this.state.lastDopamineResetDate !== dayjs().format('YYYY-MM-DD')) {
                        this.state.dopaminePointsToday = 0;
                        this.state.lastDopamineResetDate = dayjs().format('YYYY-MM-DD');
                        this.saveState();
                    }
                }, 60000); // Check every minute
            },
            
            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });
                
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // SUDS slider
                document.getElementById('sudsSlider').addEventListener('input', (e) => {
                    document.getElementById('sudsValue').textContent = e.target.value;
                });
                
                // Mood slider
                document.getElementById('moodSlider').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    let mood = 'Neutral';
                    if (value < 20) mood = 'Very Low';
                    else if (value < 40) mood = 'Low';
                    else if (value < 60) mood = 'Neutral';
                    else if (value < 80) mood = 'Good';
                    else mood = 'Excellent';
                    document.getElementById('moodValue').textContent = mood;
                });
                
                // Session notes character count
                document.getElementById('sessionNotes').addEventListener('input', (e) => {
                    const count = e.target.value.length;
                    document.getElementById('noteCharCount').textContent = count;
                    if (count > 1000) {
                        e.target.value = e.target.value.substring(0, 1000);
                    }
                });
                
                // Custom challenge difficulty slider
                const customDifficultySlider = document.getElementById('customDifficulty');
                if (customDifficultySlider) {
                    customDifficultySlider.addEventListener('input', (e) => {
                        document.getElementById('customDifficultyValue').textContent = e.target.value;
                    });
                }
                
                // Save settings automatically
                document.querySelectorAll('.form-input, .form-select, .form-checkbox').forEach(input => {
                    input.addEventListener('change', () => {
                        this.saveSettings();
                    });
                });

                // Routine Detail Modal SUDS slider
                document.getElementById('routineSudsSlider').addEventListener('input', (e) => {
                    document.getElementById('routineSudsValue').textContent = e.target.value;
                });
            },
            
            switchTab(tabId) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active class from all nav tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabId).classList.add('active');
                
                // Add active class to nav tab
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                
                // Update tab-specific content
                this.updateTabContent(tabId);
            },
            
            updateTabContent(tabId) {
                switch(tabId) {
                    case 'dashboard':
                        this.updateDashboard();
                        break;
                    case 'challenges':
                        this.renderChallenges();
                        break;
                    case 'routine':
                        routineTracker.renderDailySchedule();
                        routineTracker.updateProgressUI();
                        break;
                    case 'shop':
                        this.renderShop();
                        break;
                    case 'analytics':
                        this.renderAnalytics();
                        break;
                    case 'social':
                        this.renderSocial();
                        break;
                    case 'achievements':
                        this.renderAchievements();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            },
            
            toggleTheme() {
                if (this.state.theme === 'dark') {
                    this.state.theme = 'light';
                    document.body.classList.add('light-mode');
                    document.getElementById('themeIcon').textContent = '';
                } else {
                    this.state.theme = 'dark';
                    document.body.classList.remove('light-mode');
                    document.getElementById('themeIcon').textContent = '';
                }
                this.saveState();
            },
            
            updateUI() {
                // Update header stats
                document.getElementById('headerDopaminePoints').textContent = this.state.dopaminePoints;
                document.getElementById('headerLevel').textContent = this.state.level;
                
                // Update dashboard stats
                document.getElementById('totalChallenges').textContent = this.state.totalChallenges;
                document.getElementById('currentStreak').textContent = this.state.currentStreak;
                document.getElementById('dopaminePoints').textContent = this.state.dopaminePoints;
                document.getElementById('totalTime').textContent = `${Math.floor(this.state.totalTime / 3600)}h`;
                document.getElementById('totalAchievements').textContent = 
                    this.achievements.filter(a => a.earned).length;
                
                // Calculate average SUDS drop
                if (this.state.sessions.length > 0) {
                    const totalDrop = this.state.sessions.reduce((sum, s) => {
                        return sum + (s.preSUDS - s.postSUDS);
                    }, 0);
                    const avgDrop = Math.round(totalDrop / this.state.sessions.length);
                    document.getElementById('avgSudsDrop').textContent = `${avgDrop}%`;
                } else {
                    document.getElementById('avgSudsDrop').textContent = `0%`;
                }
                
                // Update user display
                document.getElementById('userInitial').textContent = 
                    this.state.displayName.charAt(0).toUpperCase();
                
                // Update welcome message
                const hour = dayjs().hour();
                let greeting = 'Good morning';
                if (hour >= 12 && hour < 18) greeting = 'Good afternoon';
                else if (hour >= 18) greeting = 'Good evening';
                document.getElementById('welcomeMessage').textContent = 
                    `${greeting}, ${this.state.displayName}!`;

                this.updateAvatarDisplay();
            },
            
            updateDashboard() {
                // Update today's focus challenges
                const todaysFocusChallengesDiv = document.getElementById('todaysFocusChallenges');
                todaysFocusChallengesDiv.innerHTML = '';
                
                // Display a few challenges from the general challenges tab
                const challengesToShow = this.state.todaysChallenges
                    .map(id => this.getChallenge(id))
                    .filter(c => c)
                    .slice(0, 3); // Show up to 3 challenges

                if (challengesToShow.length === 0) {
                    todaysFocusChallengesDiv.innerHTML = '<p class="text-secondary">No specific challenges scheduled for today. Check "My Routine" for your daily plan!</p>';
                } else {
                    challengesToShow.forEach(challenge => {
                        todaysFocusChallengesDiv.appendChild(this.createChallengeCard(challenge));
                    });
                }
            },
            
            renderChallenges(filter = 'all') {
                const grid = document.getElementById('challengesGrid');
                grid.innerHTML = '';
                
                let filtered = this.challenges;
                if (filter !== 'all') {
                    filtered = this.challenges.filter(c => c.category === filter);
                }
                
                // Sort by difficulty (highest first)
                filtered.sort((a, b) => b.difficulty - a.difficulty);
                
                filtered.forEach(challenge => {
                    grid.appendChild(this.createChallengeCard(challenge));
                });
            },
            
            createChallengeCard(challenge) {
                const card = document.createElement('div');
                card.className = `challenge-card ${challenge.category}`;
                card.innerHTML = `
                    <div class="challenge-header">
                        <div>
                            <div class="challenge-title">${challenge.title}</div>
                            <span class="challenge-difficulty ${challenge.category}">
                                ${challenge.difficulty}% Intensity
                            </span>
                        </div>
                    </div>
                    <div class="challenge-description">${challenge.instructions.substring(0, 150)}...</div>
                    <div class="challenge-meta">
                        <div class="challenge-meta-item">
                            <span></span> ${challenge.points.base} DP
                        </div>
                        <div class="challenge-meta-item">
                            <span></span> ${challenge.getEstimatedTime()} min
                        </div>
                        ${challenge.type ? `<div class="challenge-meta-item">
                            <span></span> ${challenge.type}
                        </div>` : ''}
                    </div>
                    <div class="challenge-actions">
                        <button class="btn btn-primary btn-sm" onclick="app.startSession('${challenge.id}')">
                            Start Challenge
                        </button>
                    </div>
                `;
                return card;
            },
            
            renderMonthlyHeatmap() {
                const heatmap = document.getElementById('monthlyHeatmap');
                heatmap.innerHTML = '';
                
                const now = dayjs();
                const daysInMonth = now.daysInMonth();
                const firstDayOfMonth = now.startOf('month').day(); // 0 for Sunday, 1 for Monday

                // Add empty cells for alignment (start from Monday)
                const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; // Adjust Sunday to be last day of week
                for (let i = 0; i < startOffset; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'heatmap-cell';
                    heatmap.appendChild(empty);
                }
                
                // Add day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = now.date(day);
                    const key = routineTracker.getRoutineKey(date);
                    const storedRoutine = JSON.parse(localStorage.getItem(key));
                    
                    let totalPoints = 0;
                    let totalSudsDrop = 0;
                    let completedCount = 0;

                    if (storedRoutine) {
                        storedRoutine.routines.forEach(routine => {
                            if (routine.completed) {
                                totalPoints += routine.points;
                                if (routine.suds.pre > 0 && routine.suds.post > 0) {
                                    totalSudsDrop += (routine.suds.pre - routine.suds.post);
                                }
                                completedCount++;
                            }
                        });
                    }

                    // Also include points from general challenges completed on this day
                    this.state.sessions.filter(s => 
                        dayjs(s.startTime).isSame(date, 'day') && !s.routineId && s.completed
                    ).forEach(session => {
                        totalPoints += session.pointsEarned;
                        if (session.preSUDS > 0 && session.postSUDS > 0) {
                            totalSudsDrop += (session.preSUDS - session.postSUDS);
                        }
                        completedCount++;
                    });
                    
                    let level = 0;
                    if (totalPoints > 0) level = 1;
                    if (totalPoints >= 100) level = 2;
                    if (totalPoints >= 250) level = 3;
                    if (totalPoints >= 500) level = 4;
                    if (totalPoints >= 1000) level = 5;
                    
                    const cell = document.createElement('div');
                    cell.className = `heatmap-cell level-${level}`;
                    cell.textContent = day;
                    cell.title = `${date.format('MMM D')}: ${totalPoints} DP, Avg SUDS Drop: ${completedCount > 0 ? Math.round(totalSudsDrop / completedCount) : 0}%`;
                    heatmap.appendChild(cell);
                }
            },
            
            renderShop() {
                const grid = document.getElementById('shopGrid');
                grid.innerHTML = '';
                
                // Update available points
                document.getElementById('shopDopaminePoints').textContent = this.state.dopaminePoints;
                
                this.shopItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = `shop-item ${item.purchased >= item.maxStack ? 'purchased' : ''}`;
                    card.innerHTML = `
                        <div class="shop-item-icon">${item.icon}</div>
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-description">${item.description}</div>
                        <div class="shop-item-cost">${item.cost} DP</div>
                        ${item.purchased >= item.maxStack ? 
                            '<button class="btn btn-secondary btn-sm" disabled>Max Owned</button>' :
                            `<button class="btn btn-primary btn-sm" onclick="app.purchaseItem('${item.id}')">
                                Purchase
                            </button>`
                        }
                    `;
                    grid.appendChild(card);
                });
            },
            
            purchaseItem(itemId) {
                const item = this.shopItems.find(i => i.id === itemId);
                if (!item || !item.canPurchase(this.state.dopaminePoints)) {
                    showNotification('Insufficient Points', 'You need more DP to purchase this item', 'danger');
                    return;
                }
                
                this.state.dopaminePoints -= item.cost;
                item.purchase();
                this.saveState();
                this.updateUI();
                this.renderShop();
            },
            
            renderAnalytics() {
                // Update performance metrics
                const totalSessions = this.state.sessions.length;
                const completedSessions = this.state.sessions.filter(s => s.completed).length;
                const successRate = totalSessions > 0 ? Math.round((completedSessions / totalSessions) * 100) : 0;
                
                document.getElementById('successRate').textContent = `${successRate}%`;
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('bestStreak').textContent = this.state.bestStreak || this.state.currentStreak;
                
                if (totalSessions > 0) {
                    const avgTime = Math.round(this.state.totalTime / totalSessions / 60);
                    document.getElementById('avgSessionTime').textContent = `${avgTime}m`;
                }
                
                // Render dopamine heatmap
                this.renderDopamineHeatmap();
                
                // Add transformation metrics
                let transformationMetrics = document.getElementById('transformationMetrics');
                if (!transformationMetrics) {
                    transformationMetrics = document.createElement('div');
                    transformationMetrics.id = 'transformationMetrics';
                    transformationMetrics.className = 'card';
                    document.getElementById('analytics').appendChild(transformationMetrics);
                }
                transformationMetrics.innerHTML = `
                    <div class="card-header">
                        <h3 class="card-title">Transformation Metrics</h3>
                    </div>
                    <div class="card-body">
                        <div class="transformation-grid">
                            <div class="metric-card">
                                <h4>Ego Deaths</h4>
                                <div class="metric-value">${this.getMetricCount('ego')}</div>
                                <div class="metric-target">Target: 28/week</div>
                            </div>
                            <div class="metric-card">
                                <h4>Cold Approaches</h4>
                                <div class="metric-value">${this.getMetricCount('social')}</div>
                                <div class="metric-target">Target: 210/week</div>
                            </div>
                            <div class="metric-card">
                                <h4>Instant Actions</h4>
                                <div class="metric-value">${this.getMetricCount('action')}</div>
                                <div class="metric-target">Target: 350/week</div>
                            </div>
                            <div class="metric-card">
                                <h4>Rejections Collected</h4>
                                <div class="metric-value">${this.getMetricCount('rejection')}</div>
                                <div class="metric-target">Target: 70/week</div>
                            </div>
                        </div>
                    </div>
                `;

                this.renderSudsProgressChart();
                this.renderChallengeDistributionChart();
                this.renderWeeklyProgressChart();
            },
            
            getMetricCount(type) {
                const weekStart = dayjs().startOf('isoWeek'); // Monday
                
                return this.state.sessions.filter(s => {
                    const sessionDate = dayjs(s.startTime);
                    const challenge = this.getChallenge(s.challengeId);
                    return sessionDate.isAfter(weekStart.subtract(1, 'day')) && // From start of week
                           challenge && 
                           (challenge.type === type || (challenge.tags && challenge.tags.includes(type))) && 
                           s.completed;
                }).length;
            },
            
            renderDopamineHeatmap() {
                const heatmap = document.getElementById('dopamineHeatmap');
                heatmap.innerHTML = '';
                
                // Last 30 days
                for (let i = 29; i >= 0; i--) {
                    const date = dayjs().subtract(i, 'day');
                    
                    const sessions = this.state.sessions.filter(s => {
                        return dayjs(s.startTime).isSame(date, 'day') && s.completed;
                    });
                    
                    const points = sessions.reduce((sum, s) => sum + s.pointsEarned, 0);
                    let level = 0;
                    if (points > 0) level = 1;
                    if (points >= 100) level = 2;
                    if (points >= 250) level = 3;
                    if (points >= 500) level = 4;
                    if (points >= 1000) level = 5;
                    
                    const cell = document.createElement('div');
                    cell.className = `heatmap-cell level-${level}`;
                    cell.textContent = date.date();
                    cell.title = `${date.format('MMM D')}: ${points} DP`;
                    heatmap.appendChild(cell);
                }
            },

            renderWeeklyProgressChart() {
                const ctx = document.getElementById('weeklyProgressChart').getContext('2d');
                if (this.weeklyProgressChartInstance) {
                    this.weeklyProgressChartInstance.destroy();
                }

                const labels = [];
                const microData = [];
                const mediumData = [];
                const heavyData = [];

                const startOfWeek = dayjs().startOf('isoWeek'); // Monday
                for (let i = 0; i < 7; i++) {
                    const date = startOfWeek.add(i, 'day');
                    labels.push(date.format('ddd'));

                    let microCount = 0;
                    let mediumCount = 0;
                    let heavyCount = 0;

                    const key = routineTracker.getRoutineKey(date);
                    const storedRoutine = JSON.parse(localStorage.getItem(key));
                    if (storedRoutine) {
                        storedRoutine.routines.forEach(r => {
                            if (r.completed) {
                                if (r.type === 'micro') microCount++;
                                if (r.type === 'medium') mediumCount++;
                                if (r.type === 'heavy') heavyCount++;
                            }
                        });
                    }
                    // Also count sessions from app.state.sessions that are not routine-based
                    app.state.sessions.filter(s => 
                        dayjs(s.startTime).isSame(date, 'day') && !s.routineId && s.completed
                    ).forEach(session => {
                        if (session.challengeType === 'micro') microCount++;
                        if (session.challengeType === 'medium') mediumCount++;
                        if (session.challengeType === 'heavy') heavyCount++;
                    });

                    microData.push(microCount);
                    mediumData.push(mediumCount);
                    heavyData.push(heavyCount);
                }

                this.weeklyProgressChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Micro Sessions',
                                data: microData,
                                backgroundColor: 'rgba(0, 255, 136, 0.6)',
                                borderColor: 'var(--low)',
                                borderWidth: 1
                            },
                            {
                                label: 'Medium Sessions',
                                data: mediumData,
                                backgroundColor: 'rgba(255, 183, 0, 0.6)',
                                borderColor: 'var(--moderate)',
                                borderWidth: 1
                            },
                            {
                                label: 'Heavy Sessions',
                                data: heavyData,
                                backgroundColor: 'rgba(255, 0, 64, 0.6)',
                                borderColor: 'var(--extreme)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'var(--text-secondary)' }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'var(--text-secondary)' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'var(--text-primary)' }
                            },
                            title: {
                                display: true,
                                text: 'Weekly Session Breakdown',
                                color: 'var(--text-primary)'
                            }
                        }
                    }
                });
            },

            renderSudsProgressChart() {
                const ctx = document.getElementById('sudsProgressChart').getContext('2d');
                if (this.sudsProgressChartInstance) {
                    this.sudsProgressChartInstance.destroy();
                }

                const labels = [];
                const preSudsData = [];
                const postSudsData = [];

                // Get data for the last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = dayjs().subtract(i, 'day');
                    labels.push(date.format('ddd'));

                    const sessionsToday = this.state.sessions.filter(s => dayjs(s.startTime).isSame(date, 'day') && s.completed);
                    if (sessionsToday.length > 0) {
                        const avgPre = sessionsToday.reduce((sum, s) => sum + s.preSUDS, 0) / sessionsToday.length;
                        const avgPost = sessionsToday.reduce((sum, s) => sum + s.postSUDS, 0) / sessionsToday.length;
                        preSudsData.push(avgPre);
                        postSudsData.push(avgPost);
                    } else {
                        preSudsData.push(null);
                        postSudsData.push(null);
                    }
                }

                this.sudsProgressChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Avg Pre-Session SUDS',
                                data: preSudsData,
                                borderColor: 'var(--extreme)',
                                backgroundColor: 'rgba(255, 0, 64, 0.2)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Avg Post-Session SUDS',
                                data: postSudsData,
                                borderColor: 'var(--accent)',
                                backgroundColor: 'rgba(0, 255, 255, 0.2)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'var(--text-secondary)' }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'var(--text-secondary)' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'var(--text-primary)' }
                            },
                            title: {
                                display: true,
                                text: 'Average Daily SUDS Levels',
                                color: 'var(--text-primary)'
                            }
                        }
                    }
                });
            },

            renderChallengeDistributionChart() {
                const ctx = document.getElementById('challengeDistributionChart').getContext('2d');
                if (this.challengeDistributionChartInstance) {
                    this.challengeDistributionChartInstance.destroy();
                }

                const categoryCounts = {
                    extreme: 0,
                    high: 0,
                    moderate: 0,
                    low: 0,
                    custom: 0
                };

                this.state.sessions.forEach(session => {
                    const challenge = this.getChallenge(session.challengeId);
                    if (challenge && session.completed) {
                        if (challenge.isCustom) {
                            categoryCounts.custom++;
                        } else {
                            categoryCounts[challenge.category]++;
                        }
                    }
                });

                this.challengeDistributionChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Extreme', 'High', 'Moderate', 'Low', 'Custom'],
                        datasets: [{
                            data: [
                                categoryCounts.extreme,
                                categoryCounts.high,
                                categoryCounts.moderate,
                                categoryCounts.low,
                                categoryCounts.custom
                            ],
                            backgroundColor: [
                                'var(--extreme)',
                                'var(--high)',
                                'var(--moderate)',
                                'var(--low)',
                                'var(--accent)'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: 'var(--text-primary)' }
                            },
                            title: {
                                display: true,
                                text: 'Challenge Completion by Category',
                                color: 'var(--text-primary)'
                            }
                        }
                    }
                });
            },
            
            renderSocial() {
                // Render leaderboard
                this.renderLeaderboard();
                
                // Render community challenges
                this.renderCommunityChallenges();
                
                // Render friend activity
                this.renderFriendActivity();
            },
            
            renderLeaderboard() {
                const list = document.getElementById('leaderboardList');
                list.innerHTML = '';
                
                // Mock leaderboard data (would come from server in real app)
                const leaderboardData = [
                    { rank: 1, name: 'NeuroPro', level: 42, points: 45000, streak: 120 },
                    { rank: 2, name: 'MindMaster', level: 38, points: 41000, streak: 95 },
                    { rank: 3, name: 'DopamineKing', level: 35, points: 38500, streak: 88 },
                    { rank: 4, name: this.state.displayName, level: this.state.level, points: this.state.dopaminePoints, streak: this.state.currentStreak },
                    { rank: 5, name: 'ChallengeChamp', level: 28, points: 31000, streak: 67 },
                    { rank: 6, name: 'ResilienceRuler', level: 25, points: 28000, streak: 54 },
                    { rank: 7, name: 'PainPower', level: 22, points: 24500, streak: 45 },
                    { rank: 8, name: 'GrowthGuru', level: 20, points: 21000, streak: 40 },
                    { rank: 9, name: 'TransformTitan', level: 18, points: 18500, streak: 35 },
                    { rank: 10, name: 'EgoSlayer', level: 15, points: 15000, streak: 30 }
                ];
                
                leaderboardData.forEach(user => {
                    const item = document.createElement('li');
                    item.className = 'leaderboard-item';
                    if (user.name === this.state.displayName) {
                        item.style.background = 'rgba(0, 255, 255, 0.1)';
                    }
                    item.innerHTML = `
                        <div class="leaderboard-rank">${user.rank}</div>
                        <div class="leaderboard-user">
                            <div class="leaderboard-name">${user.name}</div>
                            <div class="leaderboard-stats">
                                <span>Level ${user.level}</span>
                                <span> ${user.streak} days</span>
                            </div>
                        </div>
                        <div class="leaderboard-score">${user.points.toLocaleString()} DP</div>
                    `;
                    list.appendChild(item);
                });
            },
            
            renderCommunityChallenges() {
                const container = document.getElementById('communityChallenges');
                container.innerHTML = '';
                
                // Mock community challenges
                const communityChallenges = [
                    {
                        title: 'Weekend Warrior',
                        description: 'Complete 10 extreme challenges this weekend',
                        participants: 234,
                        reward: 1000
                    },
                    {
                        title: 'Rejection Rally',
                        description: 'Collect 100 rejections as a community',
                        participants: 567,
                        reward: 500
                    },
                    {
                        title: 'Ego Death Marathon',
                        description: '24-hour ego dissolution challenge',
                        participants: 89,
                        reward: 2000
                    }
                ];
                
                communityChallenges.forEach(challenge => {
                    const card = document.createElement('div');
                    card.className = 'challenge-card moderate';
                    card.innerHTML = `
                        <div class="challenge-header">
                            <div class="challenge-title">${challenge.title}</div>
                        </div>
                        <div class="challenge-description">${challenge.description}</div>
                        <div class="challenge-meta">
                            <div class="challenge-meta-item">
                                <span></span> ${challenge.participants} participants
                            </div>
                            <div class="challenge-meta-item">
                                <span></span> ${challenge.reward} DP
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm">Join Challenge</button>
                    `;
                    container.appendChild(card);
                });
            },
            
            renderFriendActivity() {
                const container = document.getElementById('friendActivity');
                container.innerHTML = '';
                
                // Mock friend activity
                const activities = [
                    { friend: 'Alex', action: 'completed EGO DEATH challenge', time: '2 hours ago', points: 150 },
                    { friend: 'Sarah', action: 'reached Level 15', time: '5 hours ago', points: 0 },
                    { friend: 'Mike', action: 'started a 30-day streak', time: '1 day ago', points: 0 },
                    { friend: 'Emma', action: 'completed COLD APPROACH MASTERY', time: '2 days ago', points: 200 }
                ];
                
                activities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'card mb-2';
                    item.style.padding = '1rem';
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <strong>${activity.friend}</strong> ${activity.action}
                                ${activity.points > 0 ? `<span style="color: gold;"> +${activity.points} DP</span>` : ''}
                            </div>
                            <span class="text-secondary">${activity.time}</span>
                        </div>
                    `;
                    container.appendChild(item);
                });
            },
            
            renderAchievements() {
                const grid = document.getElementById('badgesGrid');
                grid.innerHTML = '';
                
                const earned = this.achievements.filter(a => a.earned).length;
                const total = this.achievements.length;
                
                document.getElementById('earnedBadges').textContent = earned;
                document.getElementById('totalBadges').textContent = total;
                
                this.achievements.forEach(achievement => {
                    const badge = document.createElement('div');
                    badge.className = `badge ${achievement.earned ? 'earned' : ''}`;
                    badge.innerHTML = `
                        <div class="badge-icon">${achievement.icon}</div>
                        <div class="badge-name">${achievement.name}</div>
                        ${achievement.earned ? 
                            `<div class="text-secondary" style="font-size: 0.7rem;">${dayjs(achievement.earnedDate).format('MMM D, YYYY')}</div>` :
                            `<div class="text-secondary" style="font-size: 0.7rem;">${achievement.description}</div>`
                        }
                    `;
                    badge.title = achievement.description;
                    grid.appendChild(badge);
                });
            },
            
            loadSettings() {
                // Load user settings
                document.getElementById('displayName').value = this.state.displayName || '';
                document.getElementById('userBio').value = this.state.bio || '';
                document.getElementById('pushNotifications').checked = this.state.notifications;
                document.getElementById('soundEffects').checked = this.state.soundEnabled;
                document.getElementById('reminderTime').value = this.state.reminderTime || '09:00';
                
                // Load emergency contact
                document.getElementById('emergencyName').value = this.state.emergencyContact.name || '';
                document.getElementById('emergencyPhone').value = this.state.emergencyContact.phone || '';
            },
            
            saveSettings() {
                // Save user settings
                this.state.displayName = document.getElementById('displayName').value || 'Warrior';
                this.state.bio = document.getElementById('userBio').value;
                this.state.notifications = document.getElementById('pushNotifications').checked;
                this.state.soundEnabled = document.getElementById('soundEffects').checked;
                this.state.reminderTime = document.getElementById('reminderTime').value;
                
                this.saveState();
                this.updateUI();
                showNotification('Settings Saved', 'Your preferences have been updated', 'success');
            },
            
            saveEmergencyContact() {
                this.state.emergencyContact = {
                    name: document.getElementById('emergencyName').value,
                    phone: document.getElementById('emergencyPhone').value
                };
                this.saveState();
                showNotification('Emergency Contact Saved', 'Your emergency contact has been updated', 'success');
            },
            
            exportData() {
                const exportData = {
                    profile: {
                        userId: this.state.userId,
                        displayName: this.state.displayName,
                        level: this.state.level,
                        dopaminePoints: this.state.dopaminePoints
                    },
                    stats: {
                        totalChallenges: this.state.totalChallenges,
                        completedChallenges: this.state.completedChallenges,
                        currentStreak: this.state.currentStreak,
                        bestStreak: this.state.bestStreak,
                        totalTime: this.state.totalTime,
                        totalDopamineEarned: this.state.totalDopamineEarned
                    },
                    sessions: this.state.sessions,
                    achievements: this.achievements.filter(a => a.earned).map(a => ({
                        name: a.name,
                        earnedDate: a.earnedDate
                    })),
                    routines: this.getRoutineExportData(),
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `neuro-rewire-export-${dayjs().format('YYYY-MM-DD')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Data Exported', 'Your data has been downloaded', 'success');
            },

            getRoutineExportData() {
                const routineData = [];
                for (let i = -7; i <= 7; i++) {
                    const date = dayjs().add(i, 'day');
                    const key = routineTracker.getRoutineKey(date);
                    const stored = JSON.parse(localStorage.getItem(key));
                    if (stored) {
                        routineData.push({
                            date: date.format('YYYY-MM-DD'),
                            data: stored
                        });
                    }
                }
                return routineData;
            },

            exportCSV() {
                let csv = 'Date,Challenge,Type,Difficulty,Pre-SUDS,Post-SUDS,SUDS Drop,Duration (min),Points Earned,Notes\n';
                
                this.state.sessions.forEach(session => {
                    const challenge = this.getChallenge(session.challengeId);
                    const date = dayjs(session.startTime).format('YYYY-MM-DD HH:mm');
                    const sudsDrop = session.preSUDS - session.postSUDS;
                    const duration = Math.round(session.duration / 60);
                    const notes = session.notes.replace(/,/g, ';').replace(/\n/g, ' ');
                    
                    csv += `${date},${session.challengeTitle},${session.challengeType},${challenge ? challenge.difficulty : 'N/A'},${session.preSUDS},${session.postSUDS},${sudsDrop},${duration},${session.pointsEarned},"${notes}"\n`;
                });
                
                const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csv);
                const exportFileDefaultName = `neuro-rewire-sessions-${dayjs().format('YYYY-MM-DD')}.csv`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('CSV Exported', 'Your session data has been downloaded', 'success');
            },
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            // Merge imported data with existing data
                            if (confirm('This will merge the imported data with your existing data. Continue?')) {
                                // Merge sessions
                                if (data.sessions) {
                                    this.state.sessions = [...this.state.sessions, ...data.sessions];
                                }
                                
                                // Update stats
                                if (data.stats) {
                                    Object.assign(this.state, data.stats);
                                }
                                
                                this.saveState();
                                this.updateUI();
                                showNotification('Data Imported', 'Your data has been successfully imported', 'success');
                            }
                        } catch (error) {
                            showNotification('Import Failed', 'Invalid file format', 'danger');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            },
            
            clearAllData() {
                if (confirm('This will permanently delete all your data. Are you sure?')) {
                    if (confirm('This action cannot be undone. Are you absolutely sure?')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            },
            
            emergencyProtocol(fromSession = false) {
                // Clear any active session
                if (this.state.currentSession) {
                    clearInterval(this.state.timerInterval);
                    this.state.currentSession = null;
                }
                
                // Block heavy sessions for safety period
                this.state.heavySessionBlockedUntil = dayjs().add(HEAVY_SESSION_BLOCK_DAYS, 'day').toISOString();
                this.saveState();
                
                // Update emergency contact display
                const contactDisplay = document.getElementById('emergencyContactDisplay');
                if (this.state.emergencyContact.name && this.state.emergencyContact.phone) {
                    contactDisplay.textContent = `${this.state.emergencyContact.name}: ${this.state.emergencyContact.phone}`;
                } else {
                    contactDisplay.textContent = 'Not set - please add in Settings';
                }
                
                // Close session modal if open
                if (fromSession) {
                    document.getElementById('sessionModal').classList.remove('active');
                }
                
                // Show emergency modal
                document.getElementById('emergencyModal').classList.add('active');
                
                showNotification('Emergency Protocol Activated', 'Your safety is the priority. Heavy sessions blocked for 48 hours.', 'danger');
            },
            
            closeEmergencyModal() {
                document.getElementById('emergencyModal').classList.remove('active');
            },
            
            closeSessionModal() {
                document.getElementById('sessionModal').classList.remove('active');
                if (this.state.timerInterval) {
                    clearInterval(this.state.timerInterval);
                }
                this.state.currentSession = null;
            },
            
            closeRewardModal() {
                document.getElementById('rewardModal').classList.remove('active');
                this.state.currentSession = null;
            },
            
            closeCustomChallengeModal() {
                document.getElementById('customChallengeModal').classList.remove('active');
            },

            closeSmokeTestModal() {
                document.getElementById('smokeTestModal').classList.remove('active');
            },

            openRoutineDetailModal(routineId) {
                const key = routineTracker.getRoutineKey(routineTracker.currentDate);
                const stored = JSON.parse(localStorage.getItem(key));
                
                if (!stored) return;
                
                const routine = stored.routines.find(r => r.routineId === routineId);
                if (!routine) return;
                
                // Populate modal
                document.getElementById('routineDetailTitle').textContent = routine.task;
                document.getElementById('routineDetailTime').textContent = `Scheduled for ${routine.time}`;
                document.getElementById('routineDetailDescription').textContent = routine.description || 'No description available.';
                document.getElementById('routineDetailScience').textContent = routine.scientificExplanation || 'Scientific explanation not available.';
                document.getElementById('routineDetailInstructions').textContent = routine.instructions || 'Instructions notavailable.';
                document.getElementById('routineDetailAction').textContent = routine.exactAction || 'Exact action not specified.';
                
                // Reset SUDS slider and notes
                document.getElementById('routineSudsSlider').value = 50;
                document.getElementById('routineSudsValue').textContent = 50;
                document.getElementById('routineDetailNotes').value = '';
                
                // Set up complete button
                document.getElementById('completeRoutineBtn').onclick = () => {
                    const preSuds = parseInt(document.getElementById('routineSudsSlider').value);
                    const notes = document.getElementById('routineDetailNotes').value;
                    
                    // Mark as completed
                    routineTracker.markCompleted(
                        routineId,
                        { pre: preSuds, post: preSuds - Math.floor(Math.random() * 20 + 10) }, // Simulate SUDS drop
                        notes,
                        { suicidal: false, dissociation: false, panic: false, ptsd: false, violent: false }
                    );
                    
                    // Award points
                    let pointsEarned = routine.points;
                    
                    // Apply daily cap
                    if (this.state.dopaminePointsToday + pointsEarned > DP_DAILY_CAP) {
                        pointsEarned = DP_DAILY_CAP - this.state.dopaminePointsToday;
                        if (pointsEarned < 0) pointsEarned = 0;
                    }
                    
                    this.state.dopaminePoints += pointsEarned;
                    this.state.dopaminePointsToday += pointsEarned;
                    this.state.totalDopamineEarned += pointsEarned;
                    
                    this.saveState();
                    this.updateUI();
                    routineTracker.renderDailySchedule();
                    
                    showNotification('Routine Completed!', `+${pointsEarned} DP earned!`, 'success');
                    this.closeRoutineDetailModal();
                };
                
                // Show modal
                document.getElementById('routineDetailModal').classList.add('active');
            },
            
            closeRoutineDetailModal() {
                document.getElementById('routineDetailModal').classList.remove('active');
            },
            
            saveCustomChallenge() {
                const title = document.getElementById('customTitle').value;
                const difficulty = parseInt(document.getElementById('customDifficulty').value);
                const category = document.getElementById('customCategory').value;
                const instructions = document.getElementById('customInstructions').value;
                const identityCue = document.getElementById('customIdentity').value;
                const rewardRitual = document.getElementById('customReward').value;
                const points = parseInt(document.getElementById('customPoints').value);
                
                if (!title || !instructions) {
                    showNotification('Missing Fields', 'Please fill in at least title and instructions', 'warning');
                    return;
                }
                
                const schedule = {};
                if (document.getElementById('scheduleDaily').checked) schedule.daily = true;
                if (document.getElementById('scheduleWeekly').checked) schedule.weekly = { day: dayjs().day() };
                if (document.getElementById('scheduleMonthly').checked) schedule.monthly = { date: dayjs().date() };
                
                const customChallenge = new Challenge({
                    title,
                    difficulty,
                    category,
                    instructions,
                    identityCue,
                    rewardRitual,
                    schedule,
                    points: { base: points, missPenalty: Math.floor(points * 0.2) },
                    isCustom: true,
                    hasTimer: true,
                    type: 'custom'
                });
                
                this.challenges.push(customChallenge);
                this.saveState();
                
                showNotification('Challenge Created!', 'Your custom challenge has been added', 'success');
                this.closeCustomChallengeModal();
                this.renderChallenges();
            },
            
            startRandomChallenge() {
                const availableChallenges = this.challenges.filter(c => !c.isCustom);
                if (availableChallenges.length === 0) return;
                
                const randomChallenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
                this.startSession(randomChallenge.id);
            },

            runSmokeTests() {
                const results = [];
                let passCount = 0;
                let failCount = 0;

                // Test 1: Generate routine for today
                try {
                    const testDate = dayjs();
                    const template = routineTracker.getTodayTemplate(testDate);
                    const schedule = routineTracker.generateScheduleFor(testDate);
                    if (template && schedule && schedule.length > 0) {
                        results.push({ test: 'Generate Today\'s Routine', status: 'PASS', details: `Generated ${schedule.length} items for ${template} template` });
                        passCount++;
                    } else {
                        results.push({ test: 'Generate Today\'s Routine', status: 'FAIL', details: 'Failed to generate schedule' });
                        failCount++;
                    }
                } catch (e) {
                    results.push({ test: 'Generate Today\'s Routine', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Test 2: Simulate completing a micro session
                try {
                    const testSession = new Session(new Challenge({
                        id: 'test_micro',
                        title: 'Test Micro Session',
                        type: 'micro',
                        difficulty: 50,
                        category: 'moderate',
                        instructions: 'Test instructions',
                        identityCue: 'Test cue',
                        rewardRitual: 'Test ritual',
                        points: { base: DP_BASE_MICRO }
                    }));
                    testSession.preSUDS = 70;
                    testSession.complete({
                        postSUDS: 50,
                        postMood: 60,
                        notes: 'Test notes',
                        safetyFlags: { suicidal: false, dissociation: false, panic: false, ptsd: false, violent: false }
                    });
                    if (testSession.pointsEarned > 0) {
                        results.push({ test: 'Complete Micro Session', status: 'PASS', details: `Earned ${testSession.pointsEarned} DP` });
                        passCount++;
                    } else {
                        results.push({ test: 'Complete Micro Session', status: 'FAIL', details: 'No points earned' });
                        failCount++;
                    }
                } catch (e) {
                    results.push({ test: 'Complete Micro Session', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Test 3: Check weekly summary calculation
                try {
                    const summary = routineTracker.getWeekSummary();
                    if (summary && typeof summary.micro === 'number' && typeof summary.medium === 'number' && typeof summary.heavy === 'number') {
                        results.push({ test: 'Calculate Weekly Summary', status: 'PASS', details: `Micro: ${summary.micro}, Medium: ${summary.medium}, Heavy: ${summary.heavy}` });
                        passCount++;
                    } else {
                        results.push({ test: 'Calculate Weekly Summary', status: 'FAIL', details: 'Invalid summary structure' });
                        failCount++;
                    }
                } catch (e) {
                    results.push({ test: 'Calculate Weekly Summary', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Test 4: Check DP daily cap enforcement
                try {
                    const originalDP = this.state.dopaminePoints;
                    const originalDailyDP = this.state.dopaminePointsToday;
                    
                    // Temporarily set daily DP near cap
                    this.state.dopaminePointsToday = DP_DAILY_CAP - 10;
                    
                    // Try to earn 50 DP (should be capped at 10)
                    let earnedPoints = 50;
                    if (this.state.dopaminePointsToday + earnedPoints > DP_DAILY_CAP) {
                        earnedPoints = DP_DAILY_CAP - this.state.dopaminePointsToday;
                    }
                    
                    if (earnedPoints === 10) {
                        results.push({ test: 'DP Daily Cap Enforcement', status: 'PASS', details: `Correctly capped at ${earnedPoints} DP` });
                        passCount++;
                    } else {
                        results.push({ test: 'DP Daily Cap Enforcement', status: 'FAIL', details: `Expected 10 DP, got ${earnedPoints}` });
                        failCount++;
                    }
                    
                    // Restore original values
                    this.state.dopaminePoints = originalDP;
                    this.state.dopaminePointsToday = originalDailyDP;
                } catch (e) {
                    results.push({ test: 'DP Daily Cap Enforcement', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Test 5: Check heavy session blocking
                try {
                    const originalBlockedUntil = this.state.heavySessionBlockedUntil;
                    
                    // Set block
                    this.state.heavySessionBlockedUntil = dayjs().add(1, 'day').toISOString();
                    
                    // Check if blocked
                    const isBlocked = this.state.heavySessionBlockedUntil && dayjs().isBefore(dayjs(this.state.heavySessionBlockedUntil));
                    
                    if (isBlocked) {
                        results.push({ test: 'Heavy Session Blocking', status: 'PASS', details: 'Heavy sessions correctly blocked' });
                        passCount++;
                    } else {
                        results.push({ test: 'Heavy Session Blocking', status: 'FAIL', details: 'Heavy sessions not blocked when they should be' });
                        failCount++;
                    }
                    
                    // Restore original value
                    this.state.heavySessionBlockedUntil = originalBlockedUntil;
                } catch (e) {
                    results.push({ test: 'Heavy Session Blocking', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Test 6: Check variable-ratio bonus
                try {
                    let bonusTriggered = false;
                    // Run multiple times to check if bonus triggers
                    for (let i = 0; i < 20; i++) {
                        if (Math.random() < DP_BONUS_CHANCE) {
                            const bonus = Math.floor(Math.random() * (DP_BONUS_MAX - DP_BONUS_MIN + 1)) + DP_BONUS_MIN;
                            if (bonus >= DP_BONUS_MIN && bonus <= DP_BONUS_MAX) {
                                bonusTriggered = true;
                                break;
                            }
                        }
                    }
                    if (bonusTriggered) {
                        results.push({ test: 'Variable-Ratio Bonus', status: 'PASS', details: `Bonus system working (${DP_BONUS_CHANCE * 100}% chance)` });
                        passCount++;
                    } else {
                        results.push({ test: 'Variable-Ratio Bonus', status: 'WARNING', details: 'Bonus did not trigger in 20 attempts (may be random)' });
                        passCount++;
                    }
                } catch (e) {
                    results.push({ test: 'Variable-Ratio Bonus', status: 'FAIL', details: e.message });
                    failCount++;
                }

                // Display results
                const resultsHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h4>Test Results: ${passCount} Passed, ${failCount} Failed</h4>
                            <div style="margin-top: 1rem;">
                                ${results.map(r => `
                                    <div style="margin: 0.5rem 0; padding: 0.5rem; background: ${r.status === 'PASS' ? 'rgba(0,255,0,0.1)' : r.status === 'WARNING' ? 'rgba(255,255,0,0.1)' : 'rgba(255,0,0,0.1)'}; border-radius: 4px;">
                                        <strong>${r.test}:</strong> 
                                        <span style="color: ${r.status === 'PASS' ? 'var(--success)' : r.status === 'WARNING' ? 'var(--warning)' : 'var(--danger)'};">${r.status}</span>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">${r.details}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('smokeTestResults').innerHTML = resultsHTML;
                document.getElementById('smokeTestModal').classList.add('active');
            }
        };
        
        // Helper Functions
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate-slide-right`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-progress"></div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'notificationSlideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
        
        function playSound(type) {
            if (!app.state.soundEnabled) return;
            
            // In a real app, you would play actual sound files here
            // For now, we'll just use the Web Audio API to create simple tones
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'start':
                        oscillator.frequency.value = 523.25; // C5
                        gainNode.gain.value = 0.1;
                        break;
                    case 'complete':
                        oscillator.frequency.value = 783.99; // G5
                        gainNode.gain.value = 0.15;
                        break;
                    case 'achievement':
                        oscillator.frequency.value = 1046.50; // C6
                        gainNode.gain.value = 0.2;
                        break;
                    case 'levelup':
                        oscillator.frequency.value = 1318.51; // E6
                        gainNode.gain.value = 0.25;
                        break;
                    default:
                        oscillator.frequency.value = 440; // A4
                        gainNode.gain.value = 0.1;
                }
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Audio not supported or blocked
                console.log('Audio playback failed:', e);
            }
        }
        
        function filterChallenges(category, button) {
            // Update button states
            document.querySelectorAll('#challenges .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-ghost');
            });
            button.classList.remove('btn-ghost');
            button.classList.add('btn-primary');
            
            // Render filtered challenges
            app.renderChallenges(category);
        }
        
        function openCustomChallengeModal() {
            document.getElementById('customChallengeModal').classList.add('active');
        }
        
        // Session control functions for UI buttons
        app.startSession = function() {
            if (!this.state.currentSession) return;
            
            // Hide start button, show pause and complete buttons
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('completeBtn').classList.remove('hidden');
            
            // Log initial SUDS
            this.state.currentSession.preSUDS = parseInt(document.getElementById('sudsSlider').value);
            this.state.currentSession.preMood = parseInt(document.getElementById('moodSlider').value);
            
            showNotification('Challenge Active', 'Focus on the discomfort. Transform it into power!', 'info');
        };
        
        app.pauseSession = function() {
            this.pauseTimer();
            document.getElementById('pauseBtn').textContent = 'RESUME';
            document.getElementById('pauseBtn').onclick = () => this.resumeSession();
            showNotification('Session Paused', 'Take a moment to breathe', 'warning');
        };
        
        app.resumeSession = function() {
            this.startTimer();
            document.getElementById('pauseBtn').textContent = 'PAUSE';
            document.getElementById('pauseBtn').onclick = () => this.pauseSession();
            showNotification('Session Resumed', 'Back to transformation!', 'info');
        };
        
        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            // Show initial safety warning
            setTimeout(() => {
                if (!localStorage.getItem('safetyWarningShown')) {
                    alert(' IMPORTANT SAFETY WARNING \n\n' +
                          'This app involves psychological challenges that may trigger intense emotions.\n\n' +
                          'DO NOT USE if you have:\n' +
                          ' Active suicidal ideation\n' +
                          ' Severe mental health conditions\n' +
                          ' Recent trauma or PTSD\n' +
                          ' Dissociative disorders\n\n' +
                          'STOP IMMEDIATELY if you experience:\n' +
                          ' Suicidal thoughts\n' +
                          ' Dissociation lasting >15 minutes\n' +
                          ' Panic attacks\n' +
                          ' PTSD flashbacks\n' +
                          ' Violent impulses\n\n' +
                          'This is NOT a substitute for professional mental health care.\n' +
                          'By continuing, you acknowledge these risks.');
                    localStorage.setItem('safetyWarningShown', 'true');
                }
            }, 500);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                app.saveState();
                showNotification('Saved', 'Your progress has been saved', 'success');
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
            
            // Ctrl/Cmd + D for dashboard
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                app.switchTab('dashboard');
            }
            
            // Ctrl/Cmd + R for routine (override browser refresh)
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                app.switchTab('routine');
            }
        });
        
        // Prevent accidental navigation away
        window.addEventListener('beforeunload', (e) => {
            if (app.state.currentSession) {
                e.preventDefault();
                e.returnValue = 'You have an active session. Are you sure you want to leave?';
            }
        });
        
        // Handle visibility change (tab switching)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && app.state.currentSession) {
                // Pause timer when tab is hidden during active session
                app.pauseTimer();
            }
        });
        
        // Service Worker registration for offline support (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                // Service worker registration failed, app will still work online
            });
        }
        
        // Add PWA install prompt handler
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after user has completed at least one challenge
            if (app.state.completedChallenges > 0) {
                setTimeout(() => {
                    showNotification(
                        'Install App', 
                        'Install Neuro-Rewire for offline access and better performance!',
                        'info'
                    );
                }, 30000); // Show after 30 seconds
            }
        });
        
        // Performance monitoring
        if (window.performance && performance.mark) {
            performance.mark('app-interactive');
            
            window.addEventListener('load', () => {
                performance.mark('app-fully-loaded');
                performance.measure('app-load-time', 'app-interactive', 'app-fully-loaded');
                
                const measure = performance.getEntriesByName('app-load-time')[0];
                if (measure) {
                    console.log(`App load time: ${measure.duration.toFixed(2)}ms`);
                }
            });
        }
        
        // Error boundary
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showNotification(
                'Error Occurred', 
                'Something went wrong. Your data is safe. Please refresh if needed.',
                'danger'
            );
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>
